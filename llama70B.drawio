<mxfile host="app.diagrams.net" modified="2024-06-07T10:56:33.853Z" agent="Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/125.0.0.0 Safari/537.36" etag="UTBovfcC9cGtUbacydDU" version="24.4.8" type="github">
  <diagram name="第 1 页" id="LpuoR3_FGBAFbbzr_1aX">
    <mxGraphModel dx="2901" dy="1074" grid="1" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="1" pageScale="1" pageWidth="827" pageHeight="1169" math="0" shadow="0">
      <root>
        <mxCell id="0" />
        <mxCell id="1" parent="0" />
        <mxCell id="xuDAl61H8xCNQh_J21Wz-4" value="&lt;div data-morpho-block-id=&quot;docyg-34110e51-1745-11ef-9a70-7b1564d5e8c0&quot; class=&quot;mp-block-code-container&quot;&gt;&lt;pre style=&quot;overflow:hidden&quot; class=&quot;mp-block-code-wrapper language-python&quot; data-view=&quot;code&quot; data-indent=&quot;0&quot; data-autowrap=&quot;true&quot; data-lang=&quot;python&quot; data-title=&quot;&quot; spellcheck=&quot;false&quot;&gt;&lt;div style=&quot;overflow:auto&quot; class=&quot;mp-block-code-content mp-block-code-content-auto-wrap&quot;&gt;&lt;div data-text-content=&quot;ColumnParallelLinear&quot; class=&quot;mp-block-code-line&quot;&gt;&lt;span class=&quot;mp-block-code-line-content&quot;&gt;ParallelTransformer&lt;/span&gt;&lt;/div&gt;&lt;/div&gt;&lt;/pre&gt;&lt;/div&gt;&lt;span class=&quot;mp-morpho-clipboard-doc-data&quot; data-morpho-doc-data=&quot;{&amp;quot;token&amp;quot;:&amp;quot;eyJhbGciOiJkaXIiLCJlbmMiOiJBMjU2R0NNIiwiYXBwSWQiOjEsInVpZCI6IlJmQnhMU25WYWMiLCJkb2NJZCI6InYxdGQ2N2ZPVEs2QzRMIn0..FYDAk7L1WchX5fCR.ta4GrNma2jSnPEsQSy9PKaGV95zxd4JUsji8yob8ahPr0-s-OZ7oiy-u5s-yaoUiKDu9SJohX_wt6IuzXACLETT1kXBQPMUbdh43jhJr3_BEPeVhz35L-sNPE_ui01dfcy0HlQUjgBwty0G7TY4acA82iHRL4xHuhum2biKiGGrsiu2zuYbx5lblWmWe5e3EBS-m-B68lURKNf04OHnw5MK9ZQ.zateF23hcAoZxmPMozZGoQ&amp;quot;}&quot;&gt;&lt;/span&gt;" style="swimlane;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="150" y="890" width="1150" height="1440" as="geometry" />
        </mxCell>
        <mxCell id="xuDAl61H8xCNQh_J21Wz-5" value="RMSNorm" style="rounded=0;whiteSpace=wrap;html=1;" parent="xuDAl61H8xCNQh_J21Wz-4" vertex="1">
          <mxGeometry x="355" y="1370" width="440" height="40" as="geometry" />
        </mxCell>
        <mxCell id="xuDAl61H8xCNQh_J21Wz-9" value="&lt;div data-morpho-block-id=&quot;docyg-7fbc0191-1743-11ef-9a70-7b1564d5e8c0&quot; class=&quot;mp-block-code-container&quot;&gt;&lt;pre style=&quot;overflow:hidden&quot; class=&quot;mp-block-code-wrapper language-python&quot; data-view=&quot;code&quot; data-indent=&quot;0&quot; data-autowrap=&quot;true&quot; data-lang=&quot;python&quot; data-title=&quot;&quot; spellcheck=&quot;false&quot;&gt;&lt;div style=&quot;overflow:auto&quot; class=&quot;mp-block-code-content mp-block-code-content-auto-wrap&quot;&gt;&lt;div data-text-content=&quot;ParallelTransformerLayer&quot; class=&quot;mp-block-code-line&quot;&gt;&lt;span class=&quot;mp-block-code-line-content&quot;&gt;ParallelTransformerLayer&lt;/span&gt;&lt;/div&gt;&lt;/div&gt;&lt;/pre&gt;&lt;/div&gt;&lt;span class=&quot;mp-morpho-clipboard-doc-data&quot; data-morpho-doc-data=&quot;{&amp;quot;token&amp;quot;:&amp;quot;eyJhbGciOiJkaXIiLCJlbmMiOiJBMjU2R0NNIiwiYXBwSWQiOjEsInVpZCI6IlJmQnhMU25WYWMiLCJkb2NJZCI6InYxdGQ2N2ZPVEs2QzRMIn0..FYDAk7L1WchX5fCR.ta4GrNma2jSnPEsQSy9PKaGV95zxd4JUsji8yob8ahPr0-s-OZ7oiy-u5s-yaoUiKDu9SJohX_wt6IuzXACLETT1kXBQPMUbdh43jhJr3_BEPeVhz35L-sNPE_ui01dfcy0HlQUjgBwty0G7TY4acA82iHRL4xHuhum2biKiGGrsiu2zuYbx5lblWmWe5e3EBS-m-B68lURKNf04OHnw5MK9ZQ.zateF23hcAoZxmPMozZGoQ&amp;quot;}&quot;&gt;&lt;/span&gt;" style="swimlane;whiteSpace=wrap;html=1;" parent="xuDAl61H8xCNQh_J21Wz-4" vertex="1">
          <mxGeometry x="20" y="30" width="1120" height="1290" as="geometry" />
        </mxCell>
        <mxCell id="xuDAl61H8xCNQh_J21Wz-8" value="RMSNorm (input layernorm)" style="rounded=0;whiteSpace=wrap;html=1;" parent="xuDAl61H8xCNQh_J21Wz-9" vertex="1">
          <mxGeometry x="305" y="34" width="440" height="40" as="geometry" />
        </mxCell>
        <mxCell id="xuDAl61H8xCNQh_J21Wz-15" value="&lt;div data-morpho-block-id=&quot;docyg-8f232eb1-1743-11ef-9a70-7b1564d5e8c0&quot; class=&quot;mp-block-code-container&quot;&gt;&lt;pre style=&quot;overflow:hidden&quot; class=&quot;mp-block-code-wrapper language-python&quot; data-view=&quot;code&quot; data-indent=&quot;0&quot; data-autowrap=&quot;true&quot; data-lang=&quot;python&quot; data-title=&quot;&quot; spellcheck=&quot;false&quot;&gt;&lt;div style=&quot;overflow:auto&quot; class=&quot;mp-block-code-content mp-block-code-content-auto-wrap&quot;&gt;&lt;div data-text-content=&quot;ParallelAttention&quot; class=&quot;mp-block-code-line&quot;&gt;&lt;span class=&quot;mp-block-code-line-content&quot;&gt;ParallelAttention&lt;/span&gt;&lt;/div&gt;&lt;/div&gt;&lt;/pre&gt;&lt;/div&gt;&lt;span class=&quot;mp-morpho-clipboard-doc-data&quot; data-morpho-doc-data=&quot;{&amp;quot;token&amp;quot;:&amp;quot;eyJhbGciOiJkaXIiLCJlbmMiOiJBMjU2R0NNIiwiYXBwSWQiOjEsInVpZCI6IlJmQnhMU25WYWMiLCJkb2NJZCI6InYxdGQ2N2ZPVEs2QzRMIn0..FYDAk7L1WchX5fCR.ta4GrNma2jSnPEsQSy9PKaGV95zxd4JUsji8yob8ahPr0-s-OZ7oiy-u5s-yaoUiKDu9SJohX_wt6IuzXACLETT1kXBQPMUbdh43jhJr3_BEPeVhz35L-sNPE_ui01dfcy0HlQUjgBwty0G7TY4acA82iHRL4xHuhum2biKiGGrsiu2zuYbx5lblWmWe5e3EBS-m-B68lURKNf04OHnw5MK9ZQ.zateF23hcAoZxmPMozZGoQ&amp;quot;}&quot;&gt;&lt;/span&gt;" style="swimlane;whiteSpace=wrap;html=1;" parent="xuDAl61H8xCNQh_J21Wz-9" vertex="1">
          <mxGeometry x="20" y="90" width="1080" height="700" as="geometry" />
        </mxCell>
        <mxCell id="rBHtqcxhBLJhog4YkDWu-4" value="&lt;span style=&quot;font-size: 12px;&quot;&gt;ColumnParallelLinear (&lt;/span&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;query_key_value&lt;/span&gt;&lt;span style=&quot;font-size: 12px;&quot;&gt;)&lt;/span&gt;" style="rounded=0;whiteSpace=wrap;html=1;" parent="xuDAl61H8xCNQh_J21Wz-15" vertex="1">
          <mxGeometry x="285" y="50" width="440" height="40" as="geometry" />
        </mxCell>
        <mxCell id="rBHtqcxhBLJhog4YkDWu-5" value="&lt;span style=&quot;font-size: 12px;&quot;&gt;CoreAttention&lt;/span&gt;" style="rounded=0;whiteSpace=wrap;html=1;" parent="xuDAl61H8xCNQh_J21Wz-15" vertex="1">
          <mxGeometry x="285" y="170" width="440" height="40" as="geometry" />
        </mxCell>
        <mxCell id="rBHtqcxhBLJhog4YkDWu-6" value="&lt;span style=&quot;font-size: 12px;&quot;&gt;FlashSelfAttention&lt;/span&gt;" style="rounded=0;whiteSpace=wrap;html=1;" parent="xuDAl61H8xCNQh_J21Wz-15" vertex="1">
          <mxGeometry x="310" y="440" width="440" height="40" as="geometry" />
        </mxCell>
        <mxCell id="rBHtqcxhBLJhog4YkDWu-7" value="&lt;div data-morpho-block-id=&quot;docyg-852213c1-1745-11ef-9a70-7b1564d5e8c0&quot; class=&quot;mp-block-code-container&quot;&gt;&lt;pre style=&quot;overflow:hidden&quot; class=&quot;mp-block-code-wrapper language-python&quot; data-view=&quot;code&quot; data-indent=&quot;0&quot; data-autowrap=&quot;true&quot; data-lang=&quot;python&quot; data-title=&quot;&quot; spellcheck=&quot;false&quot;&gt;&lt;div style=&quot;overflow:auto&quot; class=&quot;mp-block-code-content mp-block-code-content-auto-wrap&quot;&gt;&lt;div data-text-content=&quot;RowParallelLinear&quot; class=&quot;mp-block-code-line&quot;&gt;&lt;span class=&quot;mp-block-code-line-content&quot;&gt;RowParallelLinear (&lt;/span&gt;&lt;span style=&quot;background-color: initial; font-family: Helvetica; white-space: normal;&quot;&gt;dense)&lt;/span&gt;&lt;/div&gt;&lt;span class=&quot;mp-morpho-clipboard-doc-data&quot; data-morpho-doc-data=&quot;{&amp;quot;token&amp;quot;:&amp;quot;eyJhbGciOiJkaXIiLCJlbmMiOiJBMjU2R0NNIiwiYXBwSWQiOjEsInVpZCI6IlJmQnhMU25WYWMiLCJkb2NJZCI6InYxdGQ2N2ZPVEs2QzRMIn0..FYDAk7L1WchX5fCR.ta4GrNma2jSnPEsQSy9PKaGV95zxd4JUsji8yob8ahPr0-s-OZ7oiy-u5s-yaoUiKDu9SJohX_wt6IuzXACLETT1kXBQPMUbdh43jhJr3_BEPeVhz35L-sNPE_ui01dfcy0HlQUjgBwty0G7TY4acA82iHRL4xHuhum2biKiGGrsiu2zuYbx5lblWmWe5e3EBS-m-B68lURKNf04OHnw5MK9ZQ.zateF23hcAoZxmPMozZGoQ&amp;quot;}&quot;&gt;&lt;/span&gt;&lt;/div&gt;&lt;/pre&gt;&lt;/div&gt;&lt;span class=&quot;mp-morpho-clipboard-doc-data&quot; data-morpho-doc-data=&quot;{&amp;quot;token&amp;quot;:&amp;quot;eyJhbGciOiJkaXIiLCJlbmMiOiJBMjU2R0NNIiwiYXBwSWQiOjEsInVpZCI6IlJmQnhMU25WYWMiLCJkb2NJZCI6InYxdGQ2N2ZPVEs2QzRMIn0..FYDAk7L1WchX5fCR.ta4GrNma2jSnPEsQSy9PKaGV95zxd4JUsji8yob8ahPr0-s-OZ7oiy-u5s-yaoUiKDu9SJohX_wt6IuzXACLETT1kXBQPMUbdh43jhJr3_BEPeVhz35L-sNPE_ui01dfcy0HlQUjgBwty0G7TY4acA82iHRL4xHuhum2biKiGGrsiu2zuYbx5lblWmWe5e3EBS-m-B68lURKNf04OHnw5MK9ZQ.zateF23hcAoZxmPMozZGoQ&amp;quot;}&quot;&gt;&lt;/span&gt;" style="rounded=0;whiteSpace=wrap;html=1;" parent="xuDAl61H8xCNQh_J21Wz-15" vertex="1">
          <mxGeometry x="310" y="570" width="440" height="40" as="geometry" />
        </mxCell>
        <mxCell id="rBHtqcxhBLJhog4YkDWu-10" value="allreduce sum" style="shape=hexagon;perimeter=hexagonPerimeter2;whiteSpace=wrap;html=1;fixedSize=1;fillColor=#f8cecc;strokeColor=#b85450;" parent="xuDAl61H8xCNQh_J21Wz-15" vertex="1">
          <mxGeometry x="460" y="640" width="120" height="30" as="geometry" />
        </mxCell>
        <mxCell id="rBHtqcxhBLJhog4YkDWu-11" value="计算通信并行&lt;div&gt;&lt;span style=&quot;font-size: 12px;&quot;&gt;--tp-gemm-parallel&lt;/span&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;font-size: 12px;&quot;&gt;--tp-kernel-split-num&lt;/span&gt;&lt;br&gt;&lt;/div&gt;" style="text;html=1;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="xuDAl61H8xCNQh_J21Wz-15" vertex="1">
          <mxGeometry x="770" y="590" width="180" height="30" as="geometry" />
        </mxCell>
        <mxCell id="xuDAl61H8xCNQh_J21Wz-16" value="&lt;div data-morpho-block-id=&quot;docyg-8f232eb1-1743-11ef-9a70-7b1564d5e8c0&quot; class=&quot;mp-block-code-container&quot;&gt;&lt;pre style=&quot;overflow:hidden&quot; class=&quot;mp-block-code-wrapper language-python&quot; data-view=&quot;code&quot; data-indent=&quot;0&quot; data-autowrap=&quot;true&quot; data-lang=&quot;python&quot; data-title=&quot;&quot; spellcheck=&quot;false&quot;&gt;&lt;div style=&quot;overflow:auto&quot; class=&quot;mp-block-code-content mp-block-code-content-auto-wrap&quot;&gt;&lt;div data-text-content=&quot;ParallelAttention&quot; class=&quot;mp-block-code-line&quot;&gt;&lt;div data-morpho-block-id=&quot;docyg-df3bca61-1743-11ef-9a70-7b1564d5e8c0&quot; class=&quot;mp-block-code-container&quot;&gt;&lt;pre style=&quot;overflow:hidden&quot; class=&quot;mp-block-code-wrapper language-python&quot; data-view=&quot;code&quot; data-indent=&quot;0&quot; data-autowrap=&quot;true&quot; data-lang=&quot;python&quot; data-title=&quot;&quot; spellcheck=&quot;false&quot;&gt;&lt;div style=&quot;overflow:auto&quot; class=&quot;mp-block-code-content mp-block-code-content-auto-wrap&quot;&gt;&lt;div data-text-content=&quot;ParallelMLP&quot; class=&quot;mp-block-code-line&quot;&gt;&lt;span class=&quot;mp-block-code-line-content&quot;&gt;ParallelMLP&lt;/span&gt;&lt;/div&gt;&lt;/div&gt;&lt;/pre&gt;&lt;/div&gt;&lt;span class=&quot;mp-morpho-clipboard-doc-data&quot; data-morpho-doc-data=&quot;{&amp;quot;token&amp;quot;:&amp;quot;eyJhbGciOiJkaXIiLCJlbmMiOiJBMjU2R0NNIiwiYXBwSWQiOjEsInVpZCI6IlJmQnhMU25WYWMiLCJkb2NJZCI6InYxdGQ2N2ZPVEs2QzRMIn0..FYDAk7L1WchX5fCR.ta4GrNma2jSnPEsQSy9PKaGV95zxd4JUsji8yob8ahPr0-s-OZ7oiy-u5s-yaoUiKDu9SJohX_wt6IuzXACLETT1kXBQPMUbdh43jhJr3_BEPeVhz35L-sNPE_ui01dfcy0HlQUjgBwty0G7TY4acA82iHRL4xHuhum2biKiGGrsiu2zuYbx5lblWmWe5e3EBS-m-B68lURKNf04OHnw5MK9ZQ.zateF23hcAoZxmPMozZGoQ&amp;quot;}&quot;&gt;&lt;/span&gt;&lt;/div&gt;&lt;/div&gt;&lt;/pre&gt;&lt;/div&gt;&lt;span class=&quot;mp-morpho-clipboard-doc-data&quot; data-morpho-doc-data=&quot;{&amp;quot;token&amp;quot;:&amp;quot;eyJhbGciOiJkaXIiLCJlbmMiOiJBMjU2R0NNIiwiYXBwSWQiOjEsInVpZCI6IlJmQnhMU25WYWMiLCJkb2NJZCI6InYxdGQ2N2ZPVEs2QzRMIn0..FYDAk7L1WchX5fCR.ta4GrNma2jSnPEsQSy9PKaGV95zxd4JUsji8yob8ahPr0-s-OZ7oiy-u5s-yaoUiKDu9SJohX_wt6IuzXACLETT1kXBQPMUbdh43jhJr3_BEPeVhz35L-sNPE_ui01dfcy0HlQUjgBwty0G7TY4acA82iHRL4xHuhum2biKiGGrsiu2zuYbx5lblWmWe5e3EBS-m-B68lURKNf04OHnw5MK9ZQ.zateF23hcAoZxmPMozZGoQ&amp;quot;}&quot;&gt;&lt;/span&gt;" style="swimlane;whiteSpace=wrap;html=1;" parent="xuDAl61H8xCNQh_J21Wz-9" vertex="1">
          <mxGeometry x="15" y="880" width="1090" height="380" as="geometry" />
        </mxCell>
        <mxCell id="xuDAl61H8xCNQh_J21Wz-17" value="&lt;span style=&quot;font-size: 12px;&quot;&gt;ColumnParallelLinear (dense h-&amp;gt;4h)&lt;/span&gt;" style="rounded=0;whiteSpace=wrap;html=1;" parent="xuDAl61H8xCNQh_J21Wz-16" vertex="1">
          <mxGeometry x="310" y="80" width="440" height="40" as="geometry" />
        </mxCell>
        <mxCell id="rBHtqcxhBLJhog4YkDWu-1" value="&lt;span style=&quot;font-size: 12px;&quot;&gt;Activation(SwiGLU)&lt;/span&gt;" style="rounded=0;whiteSpace=wrap;html=1;" parent="xuDAl61H8xCNQh_J21Wz-16" vertex="1">
          <mxGeometry x="55" y="180" width="960" height="40" as="geometry" />
        </mxCell>
        <mxCell id="rBHtqcxhBLJhog4YkDWu-2" value="&lt;span style=&quot;font-size: 12px;&quot;&gt;RowParallelLinear (dense 4h-&amp;gt; h)&lt;/span&gt;" style="rounded=0;whiteSpace=wrap;html=1;" parent="xuDAl61H8xCNQh_J21Wz-16" vertex="1">
          <mxGeometry x="290" y="260" width="460" height="40" as="geometry" />
        </mxCell>
        <mxCell id="rBHtqcxhBLJhog4YkDWu-9" value="allreduce sum" style="shape=hexagon;perimeter=hexagonPerimeter2;whiteSpace=wrap;html=1;fixedSize=1;fillColor=#f8cecc;strokeColor=#b85450;" parent="xuDAl61H8xCNQh_J21Wz-16" vertex="1">
          <mxGeometry x="475" y="330" width="120" height="30" as="geometry" />
        </mxCell>
        <mxCell id="rBHtqcxhBLJhog4YkDWu-3" value="RMSNorm" style="rounded=0;whiteSpace=wrap;html=1;" parent="xuDAl61H8xCNQh_J21Wz-9" vertex="1">
          <mxGeometry x="340" y="814" width="440" height="40" as="geometry" />
        </mxCell>
        <mxCell id="rBHtqcxhBLJhog4YkDWu-13" value="async_grad_allreduce=True" style="text;html=1;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="1690" y="960" width="220" height="30" as="geometry" />
        </mxCell>
        <mxCell id="rBHtqcxhBLJhog4YkDWu-18" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="rBHtqcxhBLJhog4YkDWu-14" target="rBHtqcxhBLJhog4YkDWu-16" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="rBHtqcxhBLJhog4YkDWu-14" value="grad_input = custom_fc(total_input, ...); #" style="rounded=0;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="1670" y="1090" width="280" height="30" as="geometry" />
        </mxCell>
        <mxCell id="rBHtqcxhBLJhog4YkDWu-15" value="async_grad_allreduce=False, SP=False" style="text;html=1;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="1320" y="1010" width="220" height="30" as="geometry" />
        </mxCell>
        <mxCell id="rBHtqcxhBLJhog4YkDWu-20" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="rBHtqcxhBLJhog4YkDWu-16" target="rBHtqcxhBLJhog4YkDWu-19" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="rBHtqcxhBLJhog4YkDWu-24" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="rBHtqcxhBLJhog4YkDWu-16" target="rBHtqcxhBLJhog4YkDWu-21" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="1520" y="1184" />
              <mxPoint x="1520" y="1385" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="rBHtqcxhBLJhog4YkDWu-16" value="handle = all_reduce(async_op=True)" style="rounded=0;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="1690" y="1169" width="240" height="30" as="geometry" />
        </mxCell>
        <mxCell id="rBHtqcxhBLJhog4YkDWu-22" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;entryX=0.5;entryY=0;entryDx=0;entryDy=0;" parent="1" source="rBHtqcxhBLJhog4YkDWu-19" target="rBHtqcxhBLJhog4YkDWu-21" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="rBHtqcxhBLJhog4YkDWu-19" value="grad_weight = custom_grad_accum(async_op=True); #CustomGradAccumWrapper&lt;div&gt;不做融合(--no-gradient-accumulation-fusion) 为grad_weight = grad_output.t().matmul(total_input) ，cuda没有融合；不加该参数会报错；&lt;br&gt;&lt;/div&gt;" style="rounded=0;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="1560" y="1260" width="500" height="50" as="geometry" />
        </mxCell>
        <mxCell id="rBHtqcxhBLJhog4YkDWu-25" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="rBHtqcxhBLJhog4YkDWu-21" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="1810" y="1440" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="rBHtqcxhBLJhog4YkDWu-21" value="handle.wait()" style="rounded=0;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="1710" y="1370" width="200" height="30" as="geometry" />
        </mxCell>
        <mxCell id="rBHtqcxhBLJhog4YkDWu-26" value="grad_input, grad_weight" style="text;html=1;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="1730" y="1450" width="160" height="20" as="geometry" />
        </mxCell>
        <mxCell id="rBHtqcxhBLJhog4YkDWu-28" value="LinearWithGradAccumulationAndAsyncCommunication反向" style="text;html=1;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=17;fontStyle=1" parent="1" vertex="1">
          <mxGeometry x="1540" y="840" width="583" height="40" as="geometry" />
        </mxCell>
        <mxCell id="rBHtqcxhBLJhog4YkDWu-29" value="LinearWithGradAccumulationAndAsyncCommunication前向" style="text;html=1;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=17;fontStyle=1" parent="1" vertex="1">
          <mxGeometry x="1518.5" y="1580" width="583" height="40" as="geometry" />
        </mxCell>
        <mxCell id="rBHtqcxhBLJhog4YkDWu-30" value="sequence_parallel" style="text;html=1;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="2160" y="960" width="220" height="30" as="geometry" />
        </mxCell>
        <mxCell id="rBHtqcxhBLJhog4YkDWu-31" value="self.embedding = VocabParallelEmbedding" style="swimlane;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="180" y="320" width="610" height="450" as="geometry" />
        </mxCell>
        <mxCell id="xuDAl61H8xCNQh_J21Wz-1" value="&lt;div data-morpho-block-id=&quot;docyg-ecc00a41-1791-11ef-9d95-d9ee3049faa0&quot; class=&quot;mp-block-code-container&quot;&gt;&lt;pre style=&quot;overflow:hidden&quot; class=&quot;mp-block-code-wrapper language-python&quot; data-view=&quot;code&quot; data-indent=&quot;0&quot; data-autowrap=&quot;true&quot; data-lang=&quot;python&quot; data-title=&quot;&quot; spellcheck=&quot;false&quot;&gt;&lt;div style=&quot;overflow:auto&quot; class=&quot;mp-block-code-content mp-block-code-content-auto-wrap&quot;&gt;&lt;div data-text-content=&quot;VocabParallelEmbedding&quot; class=&quot;mp-block-code-line&quot;&gt;&lt;span class=&quot;mp-block-code-line-content&quot;&gt;F.embedding&lt;/span&gt;&lt;/div&gt;&lt;/div&gt;&lt;/pre&gt;&lt;/div&gt;&lt;span class=&quot;mp-morpho-clipboard-doc-data&quot; data-morpho-doc-data=&quot;{&amp;quot;token&amp;quot;:&amp;quot;eyJhbGciOiJkaXIiLCJlbmMiOiJBMjU2R0NNIiwiYXBwSWQiOjEsInVpZCI6IlJmQnhMU25WYWMiLCJkb2NJZCI6InYxdGQ2N2ZPVEs2QzRMIn0..UmHZ0Ivlt-vIYASm.CDcaiiL4OmFwa69H-QSRzZiGRAAckwWbWg2N9iQupGiaayPXWUWxQkZEFBvzap2oujCTaQdMKCwWxpqSbS8iUK_vyuk4LUuEaxwe34N_6yt-fh9l0TGibDUN7RnX6ItzprpSM3pVU-mSexbOm8hofoMml7X00CbF_DVC1jMhBo1AVsClwc_UcuQxgYsZM1n7_Rvjh7e_PQsfh2Qtp5qfpJDh6g.3CywFlnfLJzl4V7BEZFGBQ&amp;quot;}&quot;&gt;&lt;/span&gt;" style="rounded=0;whiteSpace=wrap;html=1;" parent="rBHtqcxhBLJhog4YkDWu-31" vertex="1">
          <mxGeometry x="210" y="141" width="300" height="30" as="geometry" />
        </mxCell>
        <mxCell id="D8HjAB1xBHPoYr6kZlRV-5" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="rBHtqcxhBLJhog4YkDWu-31" source="D8HjAB1xBHPoYr6kZlRV-2" target="xuDAl61H8xCNQh_J21Wz-1" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="D8HjAB1xBHPoYr6kZlRV-2" value="&lt;div&gt;embedding 表&lt;/div&gt;&lt;div&gt;(V/TP x E)&lt;/div&gt;" style="rounded=0;whiteSpace=wrap;html=1;" parent="rBHtqcxhBLJhog4YkDWu-31" vertex="1">
          <mxGeometry x="60" y="140" width="90" height="33.75" as="geometry" />
        </mxCell>
        <mxCell id="D8HjAB1xBHPoYr6kZlRV-21" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;entryX=0.5;entryY=0;entryDx=0;entryDy=0;" parent="rBHtqcxhBLJhog4YkDWu-31" source="D8HjAB1xBHPoYr6kZlRV-13" target="xuDAl61H8xCNQh_J21Wz-1" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="D8HjAB1xBHPoYr6kZlRV-13" value="不属于本tp的token全部置0，&lt;b&gt;避免越界&lt;/b&gt;，后续还要请0，第0个embedding也是有值的，而我们希望是0，这样做allreduce才正确&lt;div&gt;属于该tp的token -=&amp;nbsp;vocab_start_index，因为embedding表不完整，需要减去子表的&lt;b&gt;起始offset&lt;/b&gt;&lt;/div&gt;" style="rounded=0;whiteSpace=wrap;html=1;" parent="rBHtqcxhBLJhog4YkDWu-31" vertex="1">
          <mxGeometry x="162.5" y="30" width="437.5" height="60" as="geometry" />
        </mxCell>
        <mxCell id="D8HjAB1xBHPoYr6kZlRV-23" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" parent="rBHtqcxhBLJhog4YkDWu-31" source="D8HjAB1xBHPoYr6kZlRV-15" target="D8HjAB1xBHPoYr6kZlRV-16" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="D8HjAB1xBHPoYr6kZlRV-15" value="不属于本tp的token的embedding全部置0" style="rounded=0;whiteSpace=wrap;html=1;" parent="rBHtqcxhBLJhog4YkDWu-31" vertex="1">
          <mxGeometry x="213" y="260" width="315" height="60" as="geometry" />
        </mxCell>
        <mxCell id="D8HjAB1xBHPoYr6kZlRV-16" value="allreduce sum" style="shape=hexagon;perimeter=hexagonPerimeter2;whiteSpace=wrap;html=1;fixedSize=1;fillColor=#f8cecc;strokeColor=#b85450;" parent="rBHtqcxhBLJhog4YkDWu-31" vertex="1">
          <mxGeometry x="310.5" y="380" width="120" height="30" as="geometry" />
        </mxCell>
        <mxCell id="D8HjAB1xBHPoYr6kZlRV-18" value="MBS x S" style="text;html=1;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="rBHtqcxhBLJhog4YkDWu-31" vertex="1">
          <mxGeometry x="280" y="100" width="60" height="30" as="geometry" />
        </mxCell>
        <mxCell id="D8HjAB1xBHPoYr6kZlRV-19" value="MBS x S x E" style="text;html=1;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="rBHtqcxhBLJhog4YkDWu-31" vertex="1">
          <mxGeometry x="275" y="205" width="75" height="35" as="geometry" />
        </mxCell>
        <mxCell id="D8HjAB1xBHPoYr6kZlRV-22" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;entryX=0.465;entryY=0.044;entryDx=0;entryDy=0;entryPerimeter=0;" parent="rBHtqcxhBLJhog4YkDWu-31" source="xuDAl61H8xCNQh_J21Wz-1" target="D8HjAB1xBHPoYr6kZlRV-15" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="D8HjAB1xBHPoYr6kZlRV-24" value="MBS x S x E" style="text;html=1;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="rBHtqcxhBLJhog4YkDWu-31" vertex="1">
          <mxGeometry x="272.5" y="330" width="75" height="35" as="geometry" />
        </mxCell>
        <mxCell id="D8HjAB1xBHPoYr6kZlRV-25" value="MBS x S x E" style="text;html=1;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="rBHtqcxhBLJhog4YkDWu-31" vertex="1">
          <mxGeometry x="235.5" y="405" width="75" height="35" as="geometry" />
        </mxCell>
        <mxCell id="D8HjAB1xBHPoYr6kZlRV-7" value="llama2 70B的一些超参：&lt;div&gt;词表大小 V: 32256 padded vocab (size: 32000) with 256 dummy tokens (new size: 32256)&lt;/div&gt;&lt;div&gt;E: embedding dim / hidden size 8192&lt;/div&gt;&lt;div&gt;S: sequence length 4096&lt;/div&gt;&lt;div&gt;H = 64&lt;/div&gt;&lt;div style=&quot;&quot;&gt;G: group = 8&lt;/div&gt;" style="text;html=1;align=left;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="rBHtqcxhBLJhog4YkDWu-31" vertex="1">
          <mxGeometry x="-380" y="320" width="580" height="350" as="geometry" />
        </mxCell>
        <mxCell id="D8HjAB1xBHPoYr6kZlRV-12" value="词表的大小为V * E，每一行代表一个单测对应的可学习embedding&lt;div&gt;将词表在TP上均分&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;vocab_start_index ~&amp;nbsp;vocab_end_index的词表属于该dev&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;" style="text;html=1;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="-60" y="410" width="190" height="30" as="geometry" />
        </mxCell>
        <mxCell id="D8HjAB1xBHPoYr6kZlRV-27" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;entryX=0.671;entryY=-0.033;entryDx=0;entryDy=0;entryPerimeter=0;" parent="1" source="D8HjAB1xBHPoYr6kZlRV-16" target="xuDAl61H8xCNQh_J21Wz-2" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="z7tQRWb9vEuukN400Nxw-18" value="TransformerLanguageModel" style="swimlane;whiteSpace=wrap;html=1;" vertex="1" parent="1">
          <mxGeometry x="100" y="261" width="1300" height="2679" as="geometry" />
        </mxCell>
        <mxCell id="D8HjAB1xBHPoYr6kZlRV-30" value="还有一点需要注意的，没有使用RowParrell类，有2点原因：&lt;div&gt;1. 因为input不需要梯度，只有embedding需要梯度，所以用不上RowParre&lt;/div&gt;&lt;div&gt;2. 最重要的，这不是一个linear层，而是一个embedding层，根本用不了RowPL，只是利用了TP的思想&lt;/div&gt;" style="text;html=1;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="z7tQRWb9vEuukN400Nxw-18" vertex="1">
          <mxGeometry x="-30" y="249" width="403" height="100" as="geometry" />
        </mxCell>
        <mxCell id="z7tQRWb9vEuukN400Nxw-38" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;entryX=0.5;entryY=0;entryDx=0;entryDy=0;" edge="1" parent="z7tQRWb9vEuukN400Nxw-18" source="z7tQRWb9vEuukN400Nxw-34" target="z7tQRWb9vEuukN400Nxw-37">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="z7tQRWb9vEuukN400Nxw-34" value="&amp;nbsp;self.rotary_pos_emb = RotaryEmbedding" style="swimlane;whiteSpace=wrap;html=1;" vertex="1" parent="z7tQRWb9vEuukN400Nxw-18">
          <mxGeometry x="711" y="129" width="570" height="365" as="geometry" />
        </mxCell>
        <mxCell id="xuDAl61H8xCNQh_J21Wz-2" value="encoder_input" style="rounded=0;whiteSpace=wrap;html=1;" parent="z7tQRWb9vEuukN400Nxw-18" vertex="1">
          <mxGeometry x="226" y="570" width="335" height="29" as="geometry" />
        </mxCell>
        <mxCell id="z7tQRWb9vEuukN400Nxw-35" value="seq_length (llama2 is 4096)" style="text;html=1;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" vertex="1" parent="z7tQRWb9vEuukN400Nxw-18">
          <mxGeometry x="930" y="69" width="180" height="21" as="geometry" />
        </mxCell>
        <mxCell id="z7tQRWb9vEuukN400Nxw-36" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;entryX=0.542;entryY=-0.002;entryDx=0;entryDy=0;entryPerimeter=0;" edge="1" parent="z7tQRWb9vEuukN400Nxw-18" source="z7tQRWb9vEuukN400Nxw-35" target="z7tQRWb9vEuukN400Nxw-34">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="z7tQRWb9vEuukN400Nxw-37" value="rotary_pos_emb [S, 1, 1, 128] 128是怎么来的？" style="rounded=0;whiteSpace=wrap;html=1;" vertex="1" parent="z7tQRWb9vEuukN400Nxw-18">
          <mxGeometry x="828.5" y="570" width="335" height="29" as="geometry" />
        </mxCell>
        <mxCell id="z7tQRWb9vEuukN400Nxw-39" value="内部细节暂略" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" vertex="1" parent="1">
          <mxGeometry x="1000" y="538" width="100" height="30" as="geometry" />
        </mxCell>
        <mxCell id="z7tQRWb9vEuukN400Nxw-40" value="RoPE分为两个部分&lt;div&gt;1. 生成rotary_pos_emb，只需要一次，在LanguageModel的一开始就做（是否可以优化掉，cache住）&lt;/div&gt;&lt;div&gt;2.&lt;span style=&quot;background-color: initial;&quot;&gt;&amp;nbsp;对Q, K 做&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;apply_&lt;/span&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;rotary_pos_emb&lt;/span&gt;&lt;/div&gt;" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" vertex="1" parent="1">
          <mxGeometry x="1215" y="395" width="570" height="60" as="geometry" />
        </mxCell>
      </root>
    </mxGraphModel>
  </diagram>
</mxfile>
