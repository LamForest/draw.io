<mxfile host="app.diagrams.net" modified="2024-06-19T09:05:14.353Z" agent="Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/125.0.0.0 Safari/537.36" etag="oYznGNA_o6mrNQfI_k5M" version="24.5.5" type="github">
  <diagram name="第 1 页" id="2IgsH-ITkYl6q4gYNYRC">
    <mxGraphModel dx="-5369" dy="5750" grid="1" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="1" pageScale="1" pageWidth="827" pageHeight="1169" math="0" shadow="0">
      <root>
        <mxCell id="0" />
        <mxCell id="1" parent="0" />
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-2" value="ParallelTransformerLayer" style="swimlane;whiteSpace=wrap;html=1;swimlaneFillColor=#FFF2CC;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="1">
          <mxGeometry x="8460" y="-3760" width="1380" height="4800" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-3" value="hidden_states [S/TP, B, d_m]" style="rounded=0;whiteSpace=wrap;html=1;" vertex="1" parent="2vjOk2sk5CpCFmqSpdgf-2">
          <mxGeometry x="363" y="1640" width="352" height="40" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-4" value="dropout" style="text;html=1;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" vertex="1" parent="2vjOk2sk5CpCFmqSpdgf-2">
          <mxGeometry x="471" y="1610" width="60" height="30" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-5" value="ParallelAttention" style="swimlane;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;swimlaneFillColor=#FFCCCC;" vertex="1" parent="2vjOk2sk5CpCFmqSpdgf-2">
          <mxGeometry x="140" y="1690" width="1150" height="1780" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-6" value="self.dense(context_layer)" style="text;html=1;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=15;fontStyle=1" vertex="1" parent="2vjOk2sk5CpCFmqSpdgf-2">
          <mxGeometry x="880" y="1840" width="167" height="20" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-7" value="ParallelMLP" style="swimlane;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;swimlaneFillColor=#E6D0DE;" vertex="1" parent="2vjOk2sk5CpCFmqSpdgf-2">
          <mxGeometry x="110" y="480" width="1000" height="810" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-8" value="hidden_states [S/TP, B, d_m]" style="rounded=0;whiteSpace=wrap;html=1;" vertex="1" parent="2vjOk2sk5CpCFmqSpdgf-2">
          <mxGeometry x="366" y="410" width="352" height="40" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-9" value="hidden_states [S/TP, B, d_m]" style="rounded=0;whiteSpace=wrap;html=1;" vertex="1" parent="2vjOk2sk5CpCFmqSpdgf-2">
          <mxGeometry x="364" y="1400" width="352" height="40" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-10" value="Embedding" style="swimlane;whiteSpace=wrap;html=1;swimlaneFillColor=#9AC7BF;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="2vjOk2sk5CpCFmqSpdgf-2">
          <mxGeometry x="76.75" y="3830" width="1276.5" height="938" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-11" value="Q" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;" vertex="1" parent="1">
          <mxGeometry x="8671" y="-1120" width="60" height="40" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-12" value="K" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="1">
          <mxGeometry x="9091" y="-1120" width="60" height="40" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-13" value="V" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;" vertex="1" parent="1">
          <mxGeometry x="9445" y="-1120" width="60" height="40" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-14" value="Q" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;" vertex="1" parent="1">
          <mxGeometry x="8731" y="-1120" width="60" height="40" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-15" value="K" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="1">
          <mxGeometry x="9031" y="-1120" width="60" height="40" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-16" value="V" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;" vertex="1" parent="1">
          <mxGeometry x="9386" y="-1120" width="50" height="40" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-17" value="Q" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;" vertex="1" parent="1">
          <mxGeometry x="8851" y="-1120" width="60" height="40" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-18" value="Q" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;" vertex="1" parent="1">
          <mxGeometry x="8911" y="-1120" width="60" height="40" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-19" value="..." style="text;html=1;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" vertex="1" parent="1">
          <mxGeometry x="8781" y="-1115" width="60" height="30" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-20" value="group1 query 1~8" style="text;html=1;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" vertex="1" parent="1">
          <mxGeometry x="8691" y="-1065" width="60" height="30" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-21" value="group2 query 1~8" style="text;html=1;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" vertex="1" parent="1">
          <mxGeometry x="8881" y="-1065" width="60" height="30" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-22" value="..." style="text;html=1;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" vertex="1" parent="1">
          <mxGeometry x="8961" y="-1115" width="60" height="30" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-23" value="group1&#39;s key" style="text;html=1;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" vertex="1" parent="1">
          <mxGeometry x="9021" y="-1065" width="60" height="30" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-24" value="group2&#39;s key" style="text;html=1;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" vertex="1" parent="1">
          <mxGeometry x="9091" y="-1065" width="60" height="30" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-25" value="group1&#39;s value" style="text;html=1;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" vertex="1" parent="1">
          <mxGeometry x="9386" y="-1060" width="60" height="30" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-26" value="group2&#39;s value" style="text;html=1;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" vertex="1" parent="1">
          <mxGeometry x="9456" y="-1060" width="60" height="30" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-27" value="..." style="text;html=1;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" vertex="1" parent="1">
          <mxGeometry x="9141" y="-1115" width="60" height="30" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-28" value="..." style="text;html=1;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" vertex="1" parent="1">
          <mxGeometry x="9495" y="-1120" width="60" height="30" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-29" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;entryX=0.5;entryY=1;entryDx=0;entryDy=0;" edge="1" parent="1" source="2vjOk2sk5CpCFmqSpdgf-30" target="2vjOk2sk5CpCFmqSpdgf-32">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-30" value="mixed_x_layer [S, B, group_num_per_tp x (group_size + 2) x d_h ]" style="rounded=0;whiteSpace=wrap;html=1;" vertex="1" parent="1">
          <mxGeometry x="8645" y="-750" width="710" height="40" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-31" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="2vjOk2sk5CpCFmqSpdgf-32">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="9000" y="-1000" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-32" value="mixed_x_layer [S, B, group_num_per_tp,&amp;nbsp; (group_size + 2)&amp;nbsp; * d_h ]" style="rounded=0;whiteSpace=wrap;html=1;" vertex="1" parent="1">
          <mxGeometry x="8645" y="-860" width="710" height="40" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-33" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="2vjOk2sk5CpCFmqSpdgf-34" target="2vjOk2sk5CpCFmqSpdgf-42">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-34" value="query_layer [S, B, group_num_per_tp, group_size x d_h]" style="swimlane;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;" vertex="1" parent="1">
          <mxGeometry x="8630" y="-1170" width="380" height="160" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-35" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;entryX=0.5;entryY=1;entryDx=0;entryDy=0;" edge="1" parent="1" source="2vjOk2sk5CpCFmqSpdgf-36" target="2vjOk2sk5CpCFmqSpdgf-51">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-36" value="key_layer&amp;nbsp;&lt;span style=&quot;background-color: initial;&quot;&gt;[S, B, group_num_per_tp, d_h]&lt;/span&gt;" style="swimlane;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="1">
          <mxGeometry x="9020" y="-1170" width="335" height="160" as="geometry">
            <mxRectangle x="6810" y="-1170" width="220" height="30" as="alternateBounds" />
          </mxGeometry>
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-37" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;entryX=0.5;entryY=1;entryDx=0;entryDy=0;" edge="1" parent="1" source="2vjOk2sk5CpCFmqSpdgf-38" target="2vjOk2sk5CpCFmqSpdgf-73">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-38" value="value_layer&amp;nbsp;&lt;span style=&quot;background-color: initial;&quot;&gt;[S, B, group_num_per_tp, d_h]&lt;/span&gt;" style="swimlane;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;" vertex="1" parent="1">
          <mxGeometry x="9375" y="-1170" width="340" height="160" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-39" value="view(...), 根据Q、K、V的维度做reshape" style="text;html=1;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" vertex="1" parent="1">
          <mxGeometry x="9005" y="-800" width="240" height="30" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-40" value="torch.split 将Q、K、V 分开 (view操作?)" style="text;html=1;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" vertex="1" parent="1">
          <mxGeometry x="8996" y="-930" width="240" height="30" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-41" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;entryX=0.5;entryY=1;entryDx=0;entryDy=0;" edge="1" parent="1" source="2vjOk2sk5CpCFmqSpdgf-42" target="2vjOk2sk5CpCFmqSpdgf-49">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="8820" y="-1440" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-42" value="query_layer [S, B, group_num_per_tp x group_size, d_h]" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;" vertex="1" parent="1">
          <mxGeometry x="8649" y="-1315" width="342" height="45" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-43" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="2vjOk2sk5CpCFmqSpdgf-45">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="8825" y="-1365" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-44" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="2vjOk2sk5CpCFmqSpdgf-45">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="9185" y="-1365" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-45" value="rotary_pos_emb [S, 1, 1, d_h]" style="rounded=0;whiteSpace=wrap;html=1;" vertex="1" parent="1">
          <mxGeometry x="8911" y="-1382.5" width="200" height="35" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-46" value="reshape" style="text;html=1;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" vertex="1" parent="1">
          <mxGeometry x="8825" y="-1230" width="60" height="30" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-47" value="apply_rotary_fn(query_layer, key_layer, q_pos_emb)&lt;div&gt;这里q_pos_emb k_pos_emb 都是rotary_pos_emb&lt;/div&gt;" style="text;html=1;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" vertex="1" parent="1">
          <mxGeometry x="8781" y="-1430" width="440" height="30" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-48" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;entryX=0.5;entryY=1;entryDx=0;entryDy=0;" edge="1" parent="1" source="2vjOk2sk5CpCFmqSpdgf-49" target="2vjOk2sk5CpCFmqSpdgf-56">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-49" value="query_layer [S, B, group_num_per_tp x group_size, d_h]" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;" vertex="1" parent="1">
          <mxGeometry x="8644" y="-1520" width="352" height="40" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-50" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;entryX=0.5;entryY=1;entryDx=0;entryDy=0;" edge="1" parent="1" source="2vjOk2sk5CpCFmqSpdgf-51" target="2vjOk2sk5CpCFmqSpdgf-53">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-51" value="key_layer [S, B, group_num_per_tp x group_size, d_h]" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="1">
          <mxGeometry x="9021" y="-1315" width="334" height="45" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-52" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;entryX=0.5;entryY=1;entryDx=0;entryDy=0;" edge="1" parent="1" source="2vjOk2sk5CpCFmqSpdgf-53" target="2vjOk2sk5CpCFmqSpdgf-56">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-53" value="key_layer [S, B, group_num_per_tp x group_size, d_h]" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="1">
          <mxGeometry x="9020" y="-1520" width="334" height="42.5" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-54" value="repeat_interleave(self.num_repeats, dim = 2)&lt;div&gt;num_repeats 即 group_size&lt;/div&gt;" style="text;html=1;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" vertex="1" parent="1">
          <mxGeometry x="9175" y="-1230" width="300" height="20" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-55" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;entryX=0.5;entryY=1;entryDx=0;entryDy=0;" edge="1" parent="1" source="2vjOk2sk5CpCFmqSpdgf-56" target="2vjOk2sk5CpCFmqSpdgf-58">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-56" value="&lt;div&gt;context_layer = self.core_attention_flash(&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; query_layer, key_layer, value_layer, attention_mask)&lt;/div&gt;" style="text;html=1;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" vertex="1" parent="1">
          <mxGeometry x="8818" y="-1630" width="364" height="30" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-57" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;entryX=0.5;entryY=1;entryDx=0;entryDy=0;" edge="1" parent="1" source="2vjOk2sk5CpCFmqSpdgf-58" target="2vjOk2sk5CpCFmqSpdgf-77">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="9441" y="-1860" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-58" value="context_layer [S, B, d_m / TP]" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#e1d5e7;strokeColor=#9673a6;" vertex="1" parent="1">
          <mxGeometry x="8824" y="-1730" width="352" height="40" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-59" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="2vjOk2sk5CpCFmqSpdgf-3" target="2vjOk2sk5CpCFmqSpdgf-71">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-60" value="Attention模块的tp切分很好理解，tp=1情况下group_num全部换成group_num_per_tp即可&lt;div&gt;&lt;br&gt;&lt;/div&gt;" style="text;html=1;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" vertex="1" parent="1">
          <mxGeometry x="8200" y="-2020" width="60" height="30" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-61" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;entryX=0.5;entryY=1;entryDx=0;entryDy=0;" edge="1" parent="1" source="2vjOk2sk5CpCFmqSpdgf-62" target="2vjOk2sk5CpCFmqSpdgf-82">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-62" value="hidden_states&amp;nbsp; [S/TP, B, d_m]" style="rounded=0;whiteSpace=wrap;html=1;" vertex="1" parent="1">
          <mxGeometry x="8880" y="-270" width="240" height="40" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-63" value="self.input_layernorm(hidden_states)" style="text;html=1;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" vertex="1" parent="1">
          <mxGeometry x="9000" y="-150" width="230" height="30" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-64" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;entryX=0.5;entryY=1;entryDx=0;entryDy=0;" edge="1" parent="1" source="2vjOk2sk5CpCFmqSpdgf-66" target="2vjOk2sk5CpCFmqSpdgf-62">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="9000" y="60" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-65" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" edge="1" parent="1" source="2vjOk2sk5CpCFmqSpdgf-66" target="2vjOk2sk5CpCFmqSpdgf-71">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="8500" y="-30" />
              <mxPoint x="8500" y="-2165" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-66" value="hidden_states&amp;nbsp; [S/TP, B, d_m]" style="rounded=0;whiteSpace=wrap;html=1;" vertex="1" parent="1">
          <mxGeometry x="8880" y="-50" width="240" height="40" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-67" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="2vjOk2sk5CpCFmqSpdgf-9" target="2vjOk2sk5CpCFmqSpdgf-135">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="9000" y="-2500" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-68" value="self.post_attention_layernorm(layernorm_input)" style="text;html=1;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" vertex="1" parent="1">
          <mxGeometry x="8979" y="-2240" width="309" height="10" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-69" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;entryX=0;entryY=0.5;entryDx=0;entryDy=0;exitX=0.5;exitY=0;exitDx=0;exitDy=0;" edge="1" parent="1" source="2vjOk2sk5CpCFmqSpdgf-71" target="2vjOk2sk5CpCFmqSpdgf-105">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="8510" y="-3420" as="targetPoint" />
            <Array as="points">
              <mxPoint x="9000" y="-2200" />
              <mxPoint x="8500" y="-2200" />
              <mxPoint x="8500" y="-3445" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-70" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;entryX=0.5;entryY=1;entryDx=0;entryDy=0;" edge="1" parent="1" source="2vjOk2sk5CpCFmqSpdgf-71" target="2vjOk2sk5CpCFmqSpdgf-9">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-71" value="+" style="text;html=1;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=19;fontStyle=1" vertex="1" parent="1">
          <mxGeometry x="8970" y="-2180" width="60" height="30" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-72" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" target="2vjOk2sk5CpCFmqSpdgf-56">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="9545" y="-1316" as="sourcePoint" />
            <mxPoint x="9182" y="-1623.5" as="targetPoint" />
            <Array as="points">
              <mxPoint x="9545" y="-1620" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-73" value="value_layer [S, B, group_num_per_tp x group_size, d_h]" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;" vertex="1" parent="1">
          <mxGeometry x="9378" y="-1315" width="334" height="45" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-74" value="RowPL,&amp;nbsp;sequence_parallel_enabled=True,&amp;nbsp;input_is_parallel=True" style="swimlane;whiteSpace=wrap;html=1;" vertex="1" parent="1">
          <mxGeometry x="8705.5" y="-2030" width="609" height="271" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-75" value="_reduce_scatter_along_first_dim" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" vertex="1" parent="2vjOk2sk5CpCFmqSpdgf-74">
          <mxGeometry x="295" y="50" width="200" height="30" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-76" value="&lt;div&gt;linear_with_grad_accumulation_and_async_allreduce(sequence_parallel_enabled=False)&lt;/div&gt;&lt;div&gt;Note: 在&lt;span style=&quot;background-color: initial;&quot;&gt;linear_with_grad_accumulation_and_async_allreduce中，&lt;/span&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;sequence_parallel_enabled的含义为在前向过程中，&lt;font color=&quot;#ff0000&quot;&gt;是否在fc前进行allgather&lt;/font&gt;，RowPL不需要，所以为False&lt;/span&gt;&lt;/div&gt;" style="swimlane;whiteSpace=wrap;html=1;startSize=49;" vertex="1" parent="2vjOk2sk5CpCFmqSpdgf-74">
          <mxGeometry x="11.5" y="96" width="586" height="154" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-77" value="[S, B, d_m]" style="rounded=0;whiteSpace=wrap;html=1;" vertex="1" parent="2vjOk2sk5CpCFmqSpdgf-76">
          <mxGeometry x="185.75" y="84" width="194.5" height="36.5" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-78" value="custom_fc" style="text;html=1;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" vertex="1" parent="2vjOk2sk5CpCFmqSpdgf-76">
          <mxGeometry x="201.5" y="124" width="60" height="30" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-79" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;entryX=0.5;entryY=1;entryDx=0;entryDy=0;" edge="1" parent="1" source="2vjOk2sk5CpCFmqSpdgf-82" target="2vjOk2sk5CpCFmqSpdgf-30">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-80" value="ColPL,&amp;nbsp;sequence_parallel_enabled=True,&amp;nbsp;input_is_parallel=True" style="swimlane;whiteSpace=wrap;html=1;" vertex="1" parent="1">
          <mxGeometry x="8705" y="-590" width="609" height="271" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-81" value="&lt;div&gt;linear_with_grad_accumulation_and_async_allreduce(sequence_parallel_enabled=True)&lt;/div&gt;&lt;div&gt;Note: 在&lt;span style=&quot;background-color: initial;&quot;&gt;linear_with_grad_accumulation_and_async_allreduce中，&lt;/span&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;sequence_parallel_enabled的含义为在前向过程中，&lt;font color=&quot;#ff0000&quot;&gt;是否在fc前进行allgather&lt;/font&gt;，ColPL需要，所以为True&lt;/span&gt;&lt;/div&gt;" style="swimlane;whiteSpace=wrap;html=1;startSize=49;" vertex="1" parent="2vjOk2sk5CpCFmqSpdgf-80">
          <mxGeometry x="11.5" y="40" width="586" height="210" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-82" value="[S, B, d_m]" style="rounded=0;whiteSpace=wrap;html=1;" vertex="1" parent="2vjOk2sk5CpCFmqSpdgf-81">
          <mxGeometry x="186" y="134" width="194.5" height="36.5" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-83" value="_all_gather_base" style="text;html=1;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" vertex="1" parent="2vjOk2sk5CpCFmqSpdgf-81">
          <mxGeometry x="308.5" y="170.5" width="60" height="30" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-84" value="custom_fc" style="text;html=1;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" vertex="1" parent="2vjOk2sk5CpCFmqSpdgf-81">
          <mxGeometry x="288.5" y="84" width="60" height="30" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-85" value="" style="shape=flexArrow;endArrow=classic;startArrow=classic;html=1;rounded=0;" edge="1" parent="1">
          <mxGeometry width="100" height="100" relative="1" as="geometry">
            <mxPoint x="9120" y="-365" as="sourcePoint" />
            <mxPoint x="9970" y="-365" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-86" value="" style="shape=flexArrow;endArrow=classic;startArrow=classic;html=1;rounded=0;" edge="1" parent="1">
          <mxGeometry width="100" height="100" relative="1" as="geometry">
            <mxPoint x="9201" y="-1965.5" as="sourcePoint" />
            <mxPoint x="9880" y="-1965" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-87" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="2vjOk2sk5CpCFmqSpdgf-77" target="2vjOk2sk5CpCFmqSpdgf-3">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-88" value="apply_residual_connection_post_layernorm=False&lt;div&gt;所以使用layernorm之前的hidden_state作为residual&lt;/div&gt;" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" vertex="1" parent="1">
          <mxGeometry x="8626" y="-95" width="300" height="40" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-89" value="" style="endArrow=none;dashed=1;html=1;rounded=0;strokeWidth=3;" edge="1" parent="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="8520" y="-190" as="sourcePoint" />
            <mxPoint x="9753.75" y="-190" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-90" value="ParallelTransformerLayer" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" vertex="1" connectable="0" parent="2vjOk2sk5CpCFmqSpdgf-89">
          <mxGeometry x="-0.0549" relative="1" as="geometry">
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-91" value="self.query_key_value(hidden_states)" style="text;html=1;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" vertex="1" parent="1">
          <mxGeometry x="9310" y="-470" width="220" height="20" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-92" value="" style="shape=flexArrow;endArrow=classic;startArrow=classic;html=1;rounded=0;" edge="1" parent="1">
          <mxGeometry width="100" height="100" relative="1" as="geometry">
            <mxPoint x="9110" y="-2540" as="sourcePoint" />
            <mxPoint x="9960" y="-2540" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-93" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;entryX=0.5;entryY=1;entryDx=0;entryDy=0;" edge="1" parent="1" source="2vjOk2sk5CpCFmqSpdgf-94" target="2vjOk2sk5CpCFmqSpdgf-98">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-94" value="[S, B, d_mlp / TP]" style="rounded=0;whiteSpace=wrap;html=1;" vertex="1" parent="1">
          <mxGeometry x="8904.75" y="-2860" width="194.5" height="36.5" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-95" value="RowPL,&amp;nbsp;sequence_parallel_enabled=True,&amp;nbsp;input_is_parallel=True" style="swimlane;whiteSpace=wrap;html=1;" vertex="1" parent="1">
          <mxGeometry x="8707.5" y="-3220" width="609" height="271" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-96" value="_reduce_scatter_along_first_dim" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" vertex="1" parent="2vjOk2sk5CpCFmqSpdgf-95">
          <mxGeometry x="295" y="50" width="200" height="30" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-97" value="&lt;div&gt;linear_with_grad_accumulation_and_async_allreduce(sequence_parallel_enabled=False)&lt;/div&gt;&lt;div&gt;Note: 在&lt;span style=&quot;background-color: initial;&quot;&gt;linear_with_grad_accumulation_and_async_allreduce中，&lt;/span&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;sequence_parallel_enabled的含义为在前向过程中，&lt;font color=&quot;#ff0000&quot;&gt;是否在fc前进行allgather&lt;/font&gt;，RowPL不需要，所以为False。&lt;/span&gt;&lt;/div&gt;" style="swimlane;whiteSpace=wrap;html=1;startSize=74;" vertex="1" parent="2vjOk2sk5CpCFmqSpdgf-95">
          <mxGeometry x="11.5" y="96" width="586" height="154" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-98" value="[S, B, d_m]" style="rounded=0;whiteSpace=wrap;html=1;" vertex="1" parent="2vjOk2sk5CpCFmqSpdgf-97">
          <mxGeometry x="185.75" y="84" width="194.5" height="36.5" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-99" value="custom_fc" style="text;html=1;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" vertex="1" parent="2vjOk2sk5CpCFmqSpdgf-97">
          <mxGeometry x="201.5" y="124" width="60" height="30" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-100" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="2vjOk2sk5CpCFmqSpdgf-8">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="9002" y="-3420" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-101" value="self.dense_h_to_4h" style="text;whiteSpace=wrap;" vertex="1" parent="1">
          <mxGeometry x="8578" y="-2680" width="139" height="26" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-102" value="SwiGLU" style="text;html=1;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" vertex="1" parent="1">
          <mxGeometry x="9021" y="-2810" width="60" height="30" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-103" value="self.dense_4h_to_h" style="text;whiteSpace=wrap;" vertex="1" parent="1">
          <mxGeometry x="8578" y="-3100" width="120" height="20" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-104" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;entryX=0.5;entryY=1;entryDx=0;entryDy=0;" edge="1" parent="1" source="2vjOk2sk5CpCFmqSpdgf-105" target="2vjOk2sk5CpCFmqSpdgf-108">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="9002" y="-3570" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-105" value="+" style="text;html=1;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=19;fontStyle=1" vertex="1" parent="1">
          <mxGeometry x="8972" y="-3460" width="60" height="30" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-106" value="dropout" style="text;html=1;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" vertex="1" parent="1">
          <mxGeometry x="9020" y="-3400" width="60" height="30" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-107" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;entryX=0.5;entryY=1;entryDx=0;entryDy=0;" edge="1" parent="1" source="2vjOk2sk5CpCFmqSpdgf-108" target="2vjOk2sk5CpCFmqSpdgf-129">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="9002" y="-3800" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-108" value="hidden_states [S/TP, B, d_m]" style="rounded=0;whiteSpace=wrap;html=1;" vertex="1" parent="1">
          <mxGeometry x="8826" y="-3620" width="352" height="40" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-109" value="_split_along_first_dim" style="text;whiteSpace=wrap;" vertex="1" parent="1">
          <mxGeometry x="9010" y="110" width="150" height="40" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-110" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;entryX=0.5;entryY=1;entryDx=0;entryDy=0;" edge="1" parent="1" source="2vjOk2sk5CpCFmqSpdgf-111" target="2vjOk2sk5CpCFmqSpdgf-66">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-111" value="hidden_states&amp;nbsp; [S, B, d_m]" style="rounded=0;whiteSpace=wrap;html=1;" vertex="1" parent="1">
          <mxGeometry x="8880" y="152" width="240" height="40" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-112" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;entryX=0.5;entryY=1;entryDx=0;entryDy=0;" edge="1" parent="1" source="2vjOk2sk5CpCFmqSpdgf-113" target="2vjOk2sk5CpCFmqSpdgf-111">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-113" value="hidden_states&amp;nbsp; [B, S, d_m]" style="rounded=0;whiteSpace=wrap;html=1;" vertex="1" parent="1">
          <mxGeometry x="8880" y="320" width="240" height="40" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-114" value="transpose(0, 1).contiguous()" style="text;whiteSpace=wrap;" vertex="1" parent="1">
          <mxGeometry x="9005" y="250" width="180" height="40" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-115" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="2vjOk2sk5CpCFmqSpdgf-116">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="9000" y="750" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-116" value="input [B, S]" style="rounded=0;whiteSpace=wrap;html=1;" vertex="1" parent="1">
          <mxGeometry x="8880" y="1070" width="240" height="40" as="geometry" />
        </mxCell>
        <UserObject label="&lt;div style=&quot;color: #657b83;background-color: #fdf6e3;font-family: Menlo, Monaco, &#39;Courier New&#39;, monospace;font-weight: normal;font-size: 12px;line-height: 18px;white-space: pre;&quot;&gt;&lt;div&gt;&lt;span style=&quot;color: #657b83;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #268bd2;&quot;&gt;input_mask&lt;/span&gt;&lt;span style=&quot;color: #657b83;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #859900;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #657b83;&quot;&gt; (input_ &lt;/span&gt;&lt;span style=&quot;color: #859900;&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span style=&quot;color: #657b83;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #268bd2;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #657b83;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #268bd2;&quot;&gt;vocab_start_index&lt;/span&gt;&lt;span style=&quot;color: #657b83;&quot;&gt;) &lt;/span&gt;&lt;span style=&quot;color: #859900;&quot;&gt;|&lt;/span&gt;&lt;span style=&quot;color: #657b83;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #dc322f;&quot;&gt;\&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #657b83;&quot;&gt;                         (input_ &lt;/span&gt;&lt;span style=&quot;color: #859900;&quot;&gt;&amp;gt;=&lt;/span&gt;&lt;span style=&quot;color: #657b83;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #268bd2;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #657b83;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #268bd2;&quot;&gt;vocab_end_index&lt;/span&gt;&lt;span style=&quot;color: #657b83;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #657b83;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #93a1a1;font-style: italic;&quot;&gt;# Mask the input.&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #657b83;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #268bd2;&quot;&gt;masked_input&lt;/span&gt;&lt;span style=&quot;color: #657b83;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #859900;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #657b83;&quot;&gt; input_.clone() &lt;/span&gt;&lt;span style=&quot;color: #859900;&quot;&gt;-&lt;/span&gt;&lt;span style=&quot;color: #657b83;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #268bd2;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #657b83;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #268bd2;&quot;&gt;vocab_start_index&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #657b83;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #268bd2;&quot;&gt;masked_input&lt;/span&gt;&lt;span style=&quot;color: #657b83;&quot;&gt;[&lt;/span&gt;&lt;span style=&quot;color: #268bd2;&quot;&gt;input_mask&lt;/span&gt;&lt;span style=&quot;color: #657b83;&quot;&gt;] &lt;/span&gt;&lt;span style=&quot;color: #859900;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #657b83;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #d33682;&quot;&gt;0 #避免查表越界&lt;/span&gt;&lt;/div&gt;&lt;/div&gt;" link="&lt;div style=&quot;color: #657b83;background-color: #fdf6e3;font-family: Menlo, Monaco, &#39;Courier New&#39;, monospace;font-weight: normal;font-size: 12px;line-height: 18px;white-space: pre;&quot;&gt;&lt;div&gt;&lt;span style=&quot;color: #657b83;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #268bd2;&quot;&gt;input_mask&lt;/span&gt;&lt;span style=&quot;color: #657b83;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #859900;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #657b83;&quot;&gt; (input_ &lt;/span&gt;&lt;span style=&quot;color: #859900;&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span style=&quot;color: #657b83;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #268bd2;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #657b83;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #268bd2;&quot;&gt;vocab_start_index&lt;/span&gt;&lt;span style=&quot;color: #657b83;&quot;&gt;) &lt;/span&gt;&lt;span style=&quot;color: #859900;&quot;&gt;|&lt;/span&gt;&lt;span style=&quot;color: #657b83;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #dc322f;&quot;&gt;\&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #657b83;&quot;&gt;                         (input_ &lt;/span&gt;&lt;span style=&quot;color: #859900;&quot;&gt;&amp;gt;=&lt;/span&gt;&lt;span style=&quot;color: #657b83;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #268bd2;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #657b83;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #268bd2;&quot;&gt;vocab_end_index&lt;/span&gt;&lt;span style=&quot;color: #657b83;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #657b83;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #93a1a1;font-style: italic;&quot;&gt;# Mask the input.&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #657b83;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #268bd2;&quot;&gt;masked_input&lt;/span&gt;&lt;span style=&quot;color: #657b83;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #859900;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #657b83;&quot;&gt; input_.clone() &lt;/span&gt;&lt;span style=&quot;color: #859900;&quot;&gt;-&lt;/span&gt;&lt;span style=&quot;color: #657b83;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #268bd2;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #657b83;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #268bd2;&quot;&gt;vocab_start_index&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #657b83;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #268bd2;&quot;&gt;masked_input&lt;/span&gt;&lt;span style=&quot;color: #657b83;&quot;&gt;[&lt;/span&gt;&lt;span style=&quot;color: #268bd2;&quot;&gt;input_mask&lt;/span&gt;&lt;span style=&quot;color: #657b83;&quot;&gt;] &lt;/span&gt;&lt;span style=&quot;color: #859900;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #657b83;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #d33682;&quot;&gt;0&lt;/span&gt;&lt;/div&gt;&lt;/div&gt;" id="2vjOk2sk5CpCFmqSpdgf-117">
          <mxCell style="text;whiteSpace=wrap;html=1;" vertex="1" parent="1">
            <mxGeometry x="9019" y="790" width="510" height="110" as="geometry" />
          </mxCell>
        </UserObject>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-118" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;entryX=0.5;entryY=1;entryDx=0;entryDy=0;" edge="1" parent="1" source="2vjOk2sk5CpCFmqSpdgf-119" target="2vjOk2sk5CpCFmqSpdgf-121">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-119" value="masked_input [B, S]" style="rounded=0;whiteSpace=wrap;html=1;" vertex="1" parent="1">
          <mxGeometry x="8880" y="710" width="240" height="40" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-120" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;entryX=0.5;entryY=1;entryDx=0;entryDy=0;" edge="1" parent="1" source="2vjOk2sk5CpCFmqSpdgf-121" target="2vjOk2sk5CpCFmqSpdgf-124">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-121" value="embedding [B, S, d_m]" style="rounded=0;whiteSpace=wrap;html=1;" vertex="1" parent="1">
          <mxGeometry x="8880" y="600" width="240" height="40" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-122" value="F.embedding" style="text;html=1;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" vertex="1" parent="1">
          <mxGeometry x="9010" y="660" width="60" height="30" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-123" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;entryX=0.5;entryY=1;entryDx=0;entryDy=0;" edge="1" parent="1" source="2vjOk2sk5CpCFmqSpdgf-124" target="2vjOk2sk5CpCFmqSpdgf-113">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-124" value="embedding [B, S, d_m]" style="rounded=0;whiteSpace=wrap;html=1;" vertex="1" parent="1">
          <mxGeometry x="8880" y="520" width="240" height="40" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-125" value="&lt;div style=&quot;color: #657b83;background-color: #fdf6e3;font-family: Menlo, Monaco, &#39;Courier New&#39;, monospace;font-weight: normal;font-size: 12px;line-height: 18px;white-space: pre;&quot;&gt;&lt;div&gt;&lt;span style=&quot;color: #268bd2;&quot;&gt;output_parallel&lt;/span&gt;&lt;span style=&quot;color: #657b83;&quot;&gt;[&lt;/span&gt;&lt;span style=&quot;color: #268bd2;&quot;&gt;input_mask&lt;/span&gt;&lt;span style=&quot;color: #657b83;&quot;&gt;, :] &lt;/span&gt;&lt;span style=&quot;color: #859900;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #657b83;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #d33682;&quot;&gt;0.0&lt;/span&gt;&lt;/div&gt;&lt;/div&gt;" style="text;whiteSpace=wrap;html=1;" vertex="1" parent="1">
          <mxGeometry x="9026" y="565" width="290" height="40" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-126" value="all_reduce" style="text;html=1;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" vertex="1" parent="1">
          <mxGeometry x="9010" y="460" width="60" height="30" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-127" value="Q：这个all_reduce可否跟Embeeding的&lt;span style=&quot;text-align: left;&quot;&gt;_split_along_first_dim抵消？&lt;/span&gt;&lt;div&gt;&lt;span style=&quot;text-align: left;&quot;&gt;A：不可以，这里做all_reduce是因为每个tp字典不完整；而后面的split是在S维度上做split，两者不是一回事；绝不能抵消&lt;/span&gt;&lt;/div&gt;" style="text;html=1;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" vertex="1" parent="1">
          <mxGeometry x="9151" y="500" width="379" height="40" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-128" value="self.final_layernorm(hidden_states)" style="text;whiteSpace=wrap;" vertex="1" parent="1">
          <mxGeometry x="9011" y="-3810" width="220" height="40" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-129" value="hidden_states [S/TP, B, d_m]" style="rounded=0;whiteSpace=wrap;html=1;" vertex="1" parent="1">
          <mxGeometry x="8826" y="-3880" width="352" height="40" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-130" value="VocabParallelEmbedding" style="swimlane;whiteSpace=wrap;html=1;" vertex="1" parent="1">
          <mxGeometry x="8590" y="400" width="1170" height="570" as="geometry">
            <mxRectangle x="8590" y="400" width="170" height="30" as="alternateBounds" />
          </mxGeometry>
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-131" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;entryX=0.5;entryY=1;entryDx=0;entryDy=0;" edge="1" parent="1" source="2vjOk2sk5CpCFmqSpdgf-98" target="2vjOk2sk5CpCFmqSpdgf-8">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="9002" y="-3270" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-132" value="ColPL,&amp;nbsp;sequence_parallel_enabled=True,&amp;nbsp;input_is_parallel=True" style="swimlane;whiteSpace=wrap;html=1;" vertex="1" parent="1">
          <mxGeometry x="8705.5" y="-2770" width="609" height="271" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-133" value="&lt;div&gt;linear_with_grad_accumulation_and_async_allreduce(sequence_parallel_enabled=True)&lt;/div&gt;&lt;div&gt;Note: 在&lt;span style=&quot;background-color: initial;&quot;&gt;linear_with_grad_accumulation_and_async_allreduce中，&lt;/span&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;sequence_parallel_enabled的含义为在前向过程中，&lt;font color=&quot;#ff0000&quot;&gt;是否在fc前进行allgather&lt;/font&gt;，ColPL需要，所以为True&lt;/span&gt;&lt;/div&gt;" style="swimlane;whiteSpace=wrap;html=1;startSize=49;" vertex="1" parent="2vjOk2sk5CpCFmqSpdgf-132">
          <mxGeometry x="11.5" y="40" width="586" height="210" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-134" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="2vjOk2sk5CpCFmqSpdgf-133" source="2vjOk2sk5CpCFmqSpdgf-135">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="283.25" y="-90" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-135" value="[S, B, d_m]" style="rounded=0;whiteSpace=wrap;html=1;" vertex="1" parent="2vjOk2sk5CpCFmqSpdgf-133">
          <mxGeometry x="186" y="134" width="194.5" height="36.5" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-136" value="_all_gather_base" style="text;html=1;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" vertex="1" parent="2vjOk2sk5CpCFmqSpdgf-133">
          <mxGeometry x="308.5" y="170.5" width="60" height="30" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-137" value="custom_fc" style="text;html=1;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" vertex="1" parent="2vjOk2sk5CpCFmqSpdgf-133">
          <mxGeometry x="288.5" y="84" width="60" height="30" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-138" value="TransformerLanguageModel(add_encoder=True, add_decoder-False, add_pooler=False, pre_process=True, post_process=True, norm_type=rmsnorm, decoder_attn_mask_type=AttnMaskType.causal)" style="swimlane;whiteSpace=wrap;html=1;" vertex="1" parent="1">
          <mxGeometry x="8310" y="-4170" width="1580" height="5520" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-139" value="23" style="rounded=0;whiteSpace=wrap;html=1;" vertex="1" parent="1">
          <mxGeometry x="8204" y="1610" width="63" height="50" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-140" value="&lt;span style=&quot;color: rgb(0, 0, 0); font-family: Helvetica; font-size: 18px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: 400; letter-spacing: normal; orphans: 2; text-align: center; text-indent: 0px; text-transform: none; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; white-space: normal; background-color: rgb(251, 251, 251); text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial; float: none; display: inline !important;&quot;&gt;doc_idx&lt;/span&gt;" style="text;whiteSpace=wrap;html=1;fontSize=18;" vertex="1" parent="1">
          <mxGeometry x="7987" y="1620" width="70" height="40" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-142" value="724" style="rounded=0;whiteSpace=wrap;html=1;" vertex="1" parent="1">
          <mxGeometry x="8267" y="1610" width="63" height="50" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-143" value="1" style="rounded=0;whiteSpace=wrap;html=1;" vertex="1" parent="1">
          <mxGeometry x="8330" y="1610" width="63" height="50" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-144" value="64" style="rounded=0;whiteSpace=wrap;html=1;" vertex="1" parent="1">
          <mxGeometry x="8393" y="1610" width="63" height="50" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-148" value="18" style="rounded=0;whiteSpace=wrap;html=1;" vertex="1" parent="1">
          <mxGeometry x="8456" y="1610" width="63" height="50" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-155" value="" style="rounded=0;whiteSpace=wrap;html=1;" vertex="1" parent="1">
          <mxGeometry x="8941" y="1716.65" width="908" height="60" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-157" value="" style="shape=flexArrow;endArrow=classic;html=1;rounded=0;entryX=0.287;entryY=-0.087;entryDx=0;entryDy=0;entryPerimeter=0;" edge="1" parent="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="9122.5" y="1611" as="sourcePoint" />
            <mxPoint x="9122.096" y="1696.6499999999996" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-158" value="ptr" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" vertex="1" connectable="0" parent="2vjOk2sk5CpCFmqSpdgf-157">
          <mxGeometry x="-0.5961" y="4" relative="1" as="geometry">
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-162" value="" style="shape=flexArrow;endArrow=classic;html=1;rounded=0;entryX=0.287;entryY=-0.087;entryDx=0;entryDy=0;entryPerimeter=0;" edge="1" parent="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="9179.9" y="1611" as="sourcePoint" />
            <mxPoint x="9179.496" y="1696.6499999999996" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-163" value="length" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" vertex="1" connectable="0" parent="2vjOk2sk5CpCFmqSpdgf-162">
          <mxGeometry x="-0.5961" y="4" relative="1" as="geometry">
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-167" value="" style="shape=flexArrow;endArrow=classic;html=1;rounded=0;entryX=0.287;entryY=-0.087;entryDx=0;entryDy=0;entryPerimeter=0;" edge="1" parent="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="9335.4" y="1611" as="sourcePoint" />
            <mxPoint x="9334.996" y="1696.6499999999996" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-168" value="ptr" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" vertex="1" connectable="0" parent="2vjOk2sk5CpCFmqSpdgf-167">
          <mxGeometry x="-0.5961" y="4" relative="1" as="geometry">
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-169" value="" style="shape=flexArrow;endArrow=classic;html=1;rounded=0;entryX=0.287;entryY=-0.087;entryDx=0;entryDy=0;entryPerimeter=0;" edge="1" parent="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="9455.399999999998" y="1611" as="sourcePoint" />
            <mxPoint x="9454.995999999997" y="1696.6499999999996" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-170" value="length" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" vertex="1" connectable="0" parent="2vjOk2sk5CpCFmqSpdgf-169">
          <mxGeometry x="-0.5961" y="4" relative="1" as="geometry">
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-172" value="doc 0" style="rounded=0;whiteSpace=wrap;html=1;" vertex="1" parent="1">
          <mxGeometry x="8941" y="1716.65" width="120" height="60" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-173" value="doc 1" style="rounded=0;whiteSpace=wrap;html=1;" vertex="1" parent="1">
          <mxGeometry x="9060.5" y="1716.65" width="120" height="60" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-174" value="doc 23" style="rounded=0;whiteSpace=wrap;html=1;" vertex="1" parent="1">
          <mxGeometry x="9335" y="1716.65" width="120" height="60" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-175" value="doc 724" style="rounded=0;whiteSpace=wrap;html=1;" vertex="1" parent="1">
          <mxGeometry x="9629" y="1716.65" width="120" height="60" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-176" value="" style="shape=flexArrow;endArrow=classic;html=1;rounded=0;entryX=0.287;entryY=-0.087;entryDx=0;entryDy=0;entryPerimeter=0;" edge="1" parent="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="9629.4" y="1610" as="sourcePoint" />
            <mxPoint x="9628.996" y="1695.6499999999996" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-177" value="ptr" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" vertex="1" connectable="0" parent="2vjOk2sk5CpCFmqSpdgf-176">
          <mxGeometry x="-0.5961" y="4" relative="1" as="geometry">
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-178" value="" style="shape=flexArrow;endArrow=classic;html=1;rounded=0;entryX=0.287;entryY=-0.087;entryDx=0;entryDy=0;entryPerimeter=0;" edge="1" parent="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="9686.8" y="1610" as="sourcePoint" />
            <mxPoint x="9686.395999999999" y="1695.6499999999996" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-179" value="length" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" vertex="1" connectable="0" parent="2vjOk2sk5CpCFmqSpdgf-178">
          <mxGeometry x="-0.5961" y="4" relative="1" as="geometry">
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-181" value="177" style="rounded=0;whiteSpace=wrap;html=1;" vertex="1" parent="1">
          <mxGeometry x="8141" y="1610" width="63" height="50" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-182" value="..." style="text;html=1;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=21;fontStyle=1" vertex="1" parent="1">
          <mxGeometry x="8081" y="1625" width="60" height="30" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-183" value="..." style="text;html=1;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=21;fontStyle=1" vertex="1" parent="1">
          <mxGeometry x="8518" y="1625" width="60" height="30" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-184" value="offset&lt;div&gt;100&lt;/div&gt;" style="rounded=0;whiteSpace=wrap;html=1;" vertex="1" parent="1">
          <mxGeometry x="8141" y="1500" width="86" height="50" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-185" value="&lt;span style=&quot;color: rgb(0, 0, 0); font-family: Helvetica; font-size: 18px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: 400; letter-spacing: normal; orphans: 2; text-align: center; text-indent: 0px; text-transform: none; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; white-space: normal; background-color: rgb(251, 251, 251); text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial; float: none; display: inline !important;&quot;&gt;sample_idx&lt;/span&gt;" style="text;whiteSpace=wrap;html=1;fontSize=18;" vertex="1" parent="1">
          <mxGeometry x="7987" y="1460" width="70" height="40" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-190" value="doc_index&lt;div&gt;221&lt;/div&gt;" style="rounded=0;whiteSpace=wrap;html=1;" vertex="1" parent="1">
          <mxGeometry x="8141" y="1450" width="86" height="50" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-191" value="..." style="text;html=1;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=21;fontStyle=1" vertex="1" parent="1">
          <mxGeometry x="8081" y="1465" width="60" height="30" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-192" value="..." style="text;html=1;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=21;fontStyle=1" vertex="1" parent="1">
          <mxGeometry x="8518" y="1465" width="60" height="30" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-193" value="offset&lt;div&gt;988&lt;/div&gt;" style="rounded=0;whiteSpace=wrap;html=1;" vertex="1" parent="1">
          <mxGeometry x="8227" y="1500" width="86" height="50" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-194" value="doc_index&lt;div&gt;223&lt;/div&gt;" style="rounded=0;whiteSpace=wrap;html=1;" vertex="1" parent="1">
          <mxGeometry x="8227" y="1450" width="86" height="50" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-195" value="offset" style="rounded=0;whiteSpace=wrap;html=1;" vertex="1" parent="1">
          <mxGeometry x="8313" y="1500" width="86" height="50" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-196" value="doc_index" style="rounded=0;whiteSpace=wrap;html=1;" vertex="1" parent="1">
          <mxGeometry x="8313" y="1450" width="86" height="50" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-197" value="offset" style="rounded=0;whiteSpace=wrap;html=1;" vertex="1" parent="1">
          <mxGeometry x="8399" y="1500" width="86" height="50" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-198" value="doc_index" style="rounded=0;whiteSpace=wrap;html=1;" vertex="1" parent="1">
          <mxGeometry x="8399" y="1450" width="86" height="50" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-201" value="221" style="text;html=1;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" vertex="1" parent="1">
          <mxGeometry x="8187" y="1580" width="60" height="30" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-202" value="223" style="text;html=1;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" vertex="1" parent="1">
          <mxGeometry x="8317" y="1580" width="60" height="30" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-203" value="&lt;div style=&quot;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;indexed_dataset.get(doc id = 23, offset = 100, length = None)&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 17px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;indexed_dataset.get&lt;/span&gt;(doc_id = 724, offset = 0) (中间的doc一定是完整的一段document，无需offset)&lt;/div&gt;&lt;div style=&quot;font-size: 17px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;indexed_dataset.get&lt;/span&gt;(doc_id = 1, offset = 0, length = 988 + 1) 结尾doc的可能只用了开头的一部分，&lt;/div&gt;&lt;div style=&quot;font-size: 17px;&quot;&gt;&lt;br style=&quot;font-size: 17px;&quot;&gt;&lt;/div&gt;" style="text;html=1;align=left;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=17;" vertex="1" parent="1">
          <mxGeometry x="8040" y="1732" width="870" height="78" as="geometry" />
        </mxCell>
      </root>
    </mxGraphModel>
  </diagram>
</mxfile>
