<mxfile host="app.diagrams.net" modified="2024-06-20T07:12:26.463Z" agent="Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/125.0.0.0 Safari/537.36" etag="b4LP72WRlC0IKnxWlSun" version="24.5.5" type="github">
  <diagram name="第 1 页" id="2IgsH-ITkYl6q4gYNYRC">
    <mxGraphModel dx="-4627" dy="6123" grid="1" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="1" pageScale="1" pageWidth="827" pageHeight="1169" math="0" shadow="0">
      <root>
        <mxCell id="0" />
        <mxCell id="1" parent="0" />
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-2" value="ParallelTransformerLayer" style="swimlane;whiteSpace=wrap;html=1;swimlaneFillColor=#FFF2CC;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="1">
          <mxGeometry x="8460" y="-3760" width="1380" height="3780" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-3" value="hidden_states [S/TP, B, d_m]" style="rounded=0;whiteSpace=wrap;html=1;" vertex="1" parent="2vjOk2sk5CpCFmqSpdgf-2">
          <mxGeometry x="363" y="1640" width="352" height="40" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-4" value="dropout" style="text;html=1;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" vertex="1" parent="2vjOk2sk5CpCFmqSpdgf-2">
          <mxGeometry x="471" y="1610" width="60" height="30" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-5" value="ParallelAttention" style="swimlane;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;swimlaneFillColor=#FFCCCC;" vertex="1" parent="2vjOk2sk5CpCFmqSpdgf-2">
          <mxGeometry x="140" y="1690" width="1150" height="1780" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-307" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="2vjOk2sk5CpCFmqSpdgf-5" source="2vjOk2sk5CpCFmqSpdgf-47">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="220" y="670" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-308" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="2vjOk2sk5CpCFmqSpdgf-5" source="2vjOk2sk5CpCFmqSpdgf-47">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="590" y="670" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-47" value="apply_rotary_fn(query_layer, key_layer, q_pos_emb)&lt;div&gt;这里q_pos_emb k_pos_emb 都是rotary_pos_emb&lt;/div&gt;" style="text;html=1;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" vertex="1" parent="2vjOk2sk5CpCFmqSpdgf-5">
          <mxGeometry x="260.5" y="650" width="298" height="40" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-6" value="self.dense(context_layer)" style="text;html=1;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=15;fontStyle=1" vertex="1" parent="2vjOk2sk5CpCFmqSpdgf-2">
          <mxGeometry x="880" y="1840" width="167" height="20" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-7" value="ParallelMLP" style="swimlane;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;swimlaneFillColor=#E6D0DE;" vertex="1" parent="2vjOk2sk5CpCFmqSpdgf-2">
          <mxGeometry x="110" y="480" width="1000" height="810" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-8" value="hidden_states [S/TP, B, d_m]" style="rounded=0;whiteSpace=wrap;html=1;" vertex="1" parent="2vjOk2sk5CpCFmqSpdgf-2">
          <mxGeometry x="366" y="410" width="352" height="40" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-9" value="hidden_states [S/TP, B, d_m]" style="rounded=0;whiteSpace=wrap;html=1;" vertex="1" parent="2vjOk2sk5CpCFmqSpdgf-2">
          <mxGeometry x="364" y="1400" width="352" height="40" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-10" value="Embedding" style="swimlane;whiteSpace=wrap;html=1;swimlaneFillColor=#9AC7BF;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="2vjOk2sk5CpCFmqSpdgf-2">
          <mxGeometry x="76.75" y="3830" width="1276.5" height="938" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-11" value="Q" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;" vertex="1" parent="1">
          <mxGeometry x="8671" y="-1120" width="60" height="40" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-12" value="K" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="1">
          <mxGeometry x="9091" y="-1120" width="60" height="40" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-13" value="V" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;" vertex="1" parent="1">
          <mxGeometry x="9445" y="-1120" width="60" height="40" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-14" value="Q" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;" vertex="1" parent="1">
          <mxGeometry x="8731" y="-1120" width="60" height="40" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-15" value="K" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="1">
          <mxGeometry x="9031" y="-1120" width="60" height="40" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-16" value="V" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;" vertex="1" parent="1">
          <mxGeometry x="9386" y="-1120" width="50" height="40" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-17" value="Q" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;" vertex="1" parent="1">
          <mxGeometry x="8851" y="-1120" width="60" height="40" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-18" value="Q" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;" vertex="1" parent="1">
          <mxGeometry x="8911" y="-1120" width="60" height="40" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-19" value="..." style="text;html=1;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" vertex="1" parent="1">
          <mxGeometry x="8781" y="-1115" width="60" height="30" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-20" value="group1 query 1~8" style="text;html=1;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" vertex="1" parent="1">
          <mxGeometry x="8691" y="-1065" width="60" height="30" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-21" value="group2 query 1~8" style="text;html=1;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" vertex="1" parent="1">
          <mxGeometry x="8881" y="-1065" width="60" height="30" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-22" value="..." style="text;html=1;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" vertex="1" parent="1">
          <mxGeometry x="8961" y="-1115" width="60" height="30" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-23" value="group1&#39;s key" style="text;html=1;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" vertex="1" parent="1">
          <mxGeometry x="9021" y="-1065" width="60" height="30" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-24" value="group2&#39;s key" style="text;html=1;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" vertex="1" parent="1">
          <mxGeometry x="9091" y="-1065" width="60" height="30" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-25" value="group1&#39;s value" style="text;html=1;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" vertex="1" parent="1">
          <mxGeometry x="9386" y="-1060" width="60" height="30" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-26" value="group2&#39;s value" style="text;html=1;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" vertex="1" parent="1">
          <mxGeometry x="9456" y="-1060" width="60" height="30" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-27" value="..." style="text;html=1;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" vertex="1" parent="1">
          <mxGeometry x="9141" y="-1115" width="60" height="30" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-28" value="..." style="text;html=1;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" vertex="1" parent="1">
          <mxGeometry x="9495" y="-1120" width="60" height="30" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-29" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;entryX=0.5;entryY=1;entryDx=0;entryDy=0;" edge="1" parent="1" source="2vjOk2sk5CpCFmqSpdgf-30" target="2vjOk2sk5CpCFmqSpdgf-32">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-30" value="mixed_x_layer [S, B, group_num_per_tp x (group_size + 2) x d_h ]" style="rounded=0;whiteSpace=wrap;html=1;" vertex="1" parent="1">
          <mxGeometry x="8645" y="-750" width="710" height="40" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-31" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="2vjOk2sk5CpCFmqSpdgf-32">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="9000" y="-1000" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-32" value="mixed_x_layer [S, B, group_num_per_tp,&amp;nbsp; (group_size + 2)&amp;nbsp; * d_h ]" style="rounded=0;whiteSpace=wrap;html=1;" vertex="1" parent="1">
          <mxGeometry x="8645" y="-860" width="710" height="40" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-33" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="2vjOk2sk5CpCFmqSpdgf-34" target="2vjOk2sk5CpCFmqSpdgf-42">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-34" value="query_layer [S, B, group_num_per_tp, group_size x d_h]" style="swimlane;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;" vertex="1" parent="1">
          <mxGeometry x="8630" y="-1170" width="380" height="160" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-35" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;entryX=0.5;entryY=1;entryDx=0;entryDy=0;" edge="1" parent="1" source="2vjOk2sk5CpCFmqSpdgf-36" target="2vjOk2sk5CpCFmqSpdgf-51">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-36" value="key_layer&amp;nbsp;&lt;span style=&quot;background-color: initial;&quot;&gt;[S, B, group_num_per_tp, d_h]&lt;/span&gt;" style="swimlane;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="1">
          <mxGeometry x="9020" y="-1170" width="335" height="160" as="geometry">
            <mxRectangle x="6810" y="-1170" width="220" height="30" as="alternateBounds" />
          </mxGeometry>
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-37" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;entryX=0.5;entryY=1;entryDx=0;entryDy=0;" edge="1" parent="1" source="2vjOk2sk5CpCFmqSpdgf-38" target="2vjOk2sk5CpCFmqSpdgf-73">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-38" value="value_layer&amp;nbsp;&lt;span style=&quot;background-color: initial;&quot;&gt;[S, B, group_num_per_tp, d_h]&lt;/span&gt;" style="swimlane;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;" vertex="1" parent="1">
          <mxGeometry x="9375" y="-1170" width="340" height="160" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-39" value="view(...), 根据Q、K、V的维度做reshape" style="text;html=1;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" vertex="1" parent="1">
          <mxGeometry x="9005" y="-800" width="240" height="30" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-40" value="torch.split 将Q、K、V 分开 (view操作?)" style="text;html=1;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" vertex="1" parent="1">
          <mxGeometry x="8996" y="-930" width="240" height="30" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-42" value="query_layer [S, B, group_num_per_tp x group_size, d_h]" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;" vertex="1" parent="1">
          <mxGeometry x="8649" y="-1315" width="342" height="45" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-46" value="reshape" style="text;html=1;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" vertex="1" parent="1">
          <mxGeometry x="8825" y="-1230" width="60" height="30" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-48" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;entryX=0.5;entryY=1;entryDx=0;entryDy=0;" edge="1" parent="1" source="2vjOk2sk5CpCFmqSpdgf-49" target="2vjOk2sk5CpCFmqSpdgf-56">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-49" value="query_layer [S, B, group_num_per_tp x group_size, d_h]" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;" vertex="1" parent="1">
          <mxGeometry x="8644" y="-1520" width="352" height="40" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-51" value="key_layer [S, B, group_num_per_tp x group_size, d_h]" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="1">
          <mxGeometry x="9021" y="-1315" width="334" height="45" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-52" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;entryX=0.5;entryY=1;entryDx=0;entryDy=0;" edge="1" parent="1" source="2vjOk2sk5CpCFmqSpdgf-53" target="2vjOk2sk5CpCFmqSpdgf-56">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-53" value="key_layer [S, B, group_num_per_tp x group_size, d_h]" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="1">
          <mxGeometry x="9020" y="-1520" width="334" height="42.5" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-54" value="repeat_interleave(self.num_repeats, dim = 2)&lt;div&gt;num_repeats 即 group_size&lt;/div&gt;" style="text;html=1;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" vertex="1" parent="1">
          <mxGeometry x="9175" y="-1230" width="300" height="20" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-55" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;entryX=0.5;entryY=1;entryDx=0;entryDy=0;" edge="1" parent="1" source="2vjOk2sk5CpCFmqSpdgf-56" target="2vjOk2sk5CpCFmqSpdgf-58">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-56" value="&lt;div&gt;context_layer = self.core_attention_flash(&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; query_layer, key_layer, value_layer, attention_mask)&lt;/div&gt;" style="text;html=1;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" vertex="1" parent="1">
          <mxGeometry x="8818" y="-1630" width="364" height="30" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-57" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;entryX=0.5;entryY=1;entryDx=0;entryDy=0;" edge="1" parent="1" source="2vjOk2sk5CpCFmqSpdgf-58" target="2vjOk2sk5CpCFmqSpdgf-77">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="9441" y="-1860" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-58" value="context_layer [S, B, d_m / TP]" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#e1d5e7;strokeColor=#9673a6;" vertex="1" parent="1">
          <mxGeometry x="8824" y="-1730" width="352" height="40" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-59" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="2vjOk2sk5CpCFmqSpdgf-3" target="2vjOk2sk5CpCFmqSpdgf-71">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-60" value="Attention模块的tp切分很好理解，tp=1情况下group_num全部换成group_num_per_tp即可&lt;div&gt;&lt;br&gt;&lt;/div&gt;" style="text;html=1;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" vertex="1" parent="1">
          <mxGeometry x="8200" y="-2020" width="60" height="30" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-61" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;entryX=0.5;entryY=1;entryDx=0;entryDy=0;" edge="1" parent="1" source="2vjOk2sk5CpCFmqSpdgf-62" target="2vjOk2sk5CpCFmqSpdgf-82">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-62" value="hidden_states&amp;nbsp; [S/TP, B, d_m]" style="rounded=0;whiteSpace=wrap;html=1;" vertex="1" parent="1">
          <mxGeometry x="8880" y="-270" width="240" height="40" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-63" value="self.input_layernorm(hidden_states)" style="text;html=1;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" vertex="1" parent="1">
          <mxGeometry x="9000" y="-150" width="230" height="30" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-64" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;entryX=0.5;entryY=1;entryDx=0;entryDy=0;" edge="1" parent="1" source="2vjOk2sk5CpCFmqSpdgf-66" target="2vjOk2sk5CpCFmqSpdgf-62">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="9000" y="60" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-65" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" edge="1" parent="1" source="2vjOk2sk5CpCFmqSpdgf-66" target="2vjOk2sk5CpCFmqSpdgf-71">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="8500" y="-30" />
              <mxPoint x="8500" y="-2165" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-66" value="hidden_states&amp;nbsp; [S/TP, B, d_m]" style="rounded=0;whiteSpace=wrap;html=1;" vertex="1" parent="1">
          <mxGeometry x="8880" y="-50" width="240" height="40" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-67" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="2vjOk2sk5CpCFmqSpdgf-9" target="2vjOk2sk5CpCFmqSpdgf-135">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="9000" y="-2500" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-68" value="self.post_attention_layernorm(layernorm_input)" style="text;html=1;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" vertex="1" parent="1">
          <mxGeometry x="8979" y="-2240" width="309" height="10" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-69" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;entryX=0;entryY=0.5;entryDx=0;entryDy=0;exitX=0.5;exitY=0;exitDx=0;exitDy=0;" edge="1" parent="1" source="2vjOk2sk5CpCFmqSpdgf-71" target="2vjOk2sk5CpCFmqSpdgf-105">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="8510" y="-3420" as="targetPoint" />
            <Array as="points">
              <mxPoint x="9000" y="-2200" />
              <mxPoint x="8500" y="-2200" />
              <mxPoint x="8500" y="-3445" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-70" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;entryX=0.5;entryY=1;entryDx=0;entryDy=0;" edge="1" parent="1" source="2vjOk2sk5CpCFmqSpdgf-71" target="2vjOk2sk5CpCFmqSpdgf-9">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-71" value="+" style="text;html=1;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=19;fontStyle=1" vertex="1" parent="1">
          <mxGeometry x="8970" y="-2180" width="60" height="30" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-72" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" target="2vjOk2sk5CpCFmqSpdgf-56">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="9545" y="-1316" as="sourcePoint" />
            <mxPoint x="9182" y="-1623.5" as="targetPoint" />
            <Array as="points">
              <mxPoint x="9545" y="-1620" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-73" value="value_layer [S, B, group_num_per_tp x group_size, d_h]" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;" vertex="1" parent="1">
          <mxGeometry x="9378" y="-1315" width="334" height="45" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-74" value="RowPL,&amp;nbsp;sequence_parallel_enabled=True,&amp;nbsp;input_is_parallel=True" style="swimlane;whiteSpace=wrap;html=1;" vertex="1" parent="1">
          <mxGeometry x="8705.5" y="-2030" width="609" height="271" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-75" value="_reduce_scatter_along_first_dim" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" vertex="1" parent="2vjOk2sk5CpCFmqSpdgf-74">
          <mxGeometry x="295" y="50" width="200" height="30" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-76" value="&lt;div&gt;linear_with_grad_accumulation_and_async_allreduce(sequence_parallel_enabled=False)&lt;/div&gt;&lt;div&gt;Note: 在&lt;span style=&quot;background-color: initial;&quot;&gt;linear_with_grad_accumulation_and_async_allreduce中，&lt;/span&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;sequence_parallel_enabled的含义为在前向过程中，&lt;font color=&quot;#ff0000&quot;&gt;是否在fc前进行allgather&lt;/font&gt;，RowPL不需要，所以为False&lt;/span&gt;&lt;/div&gt;" style="swimlane;whiteSpace=wrap;html=1;startSize=49;" vertex="1" parent="2vjOk2sk5CpCFmqSpdgf-74">
          <mxGeometry x="11.5" y="96" width="586" height="154" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-77" value="[S, B, d_m]" style="rounded=0;whiteSpace=wrap;html=1;" vertex="1" parent="2vjOk2sk5CpCFmqSpdgf-76">
          <mxGeometry x="185.75" y="84" width="194.5" height="36.5" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-78" value="custom_fc" style="text;html=1;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" vertex="1" parent="2vjOk2sk5CpCFmqSpdgf-76">
          <mxGeometry x="201.5" y="124" width="60" height="30" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-79" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;entryX=0.5;entryY=1;entryDx=0;entryDy=0;" edge="1" parent="1" source="2vjOk2sk5CpCFmqSpdgf-82" target="2vjOk2sk5CpCFmqSpdgf-30">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-80" value="ColPL,&amp;nbsp;sequence_parallel_enabled=True,&amp;nbsp;input_is_parallel=True" style="swimlane;whiteSpace=wrap;html=1;" vertex="1" parent="1">
          <mxGeometry x="8705" y="-590" width="609" height="271" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-81" value="&lt;div&gt;linear_with_grad_accumulation_and_async_allreduce(sequence_parallel_enabled=True)&lt;/div&gt;&lt;div&gt;Note: 在&lt;span style=&quot;background-color: initial;&quot;&gt;linear_with_grad_accumulation_and_async_allreduce中，&lt;/span&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;sequence_parallel_enabled的含义为在前向过程中，&lt;font color=&quot;#ff0000&quot;&gt;是否在fc前进行allgather&lt;/font&gt;，ColPL需要，所以为True&lt;/span&gt;&lt;/div&gt;" style="swimlane;whiteSpace=wrap;html=1;startSize=49;" vertex="1" parent="2vjOk2sk5CpCFmqSpdgf-80">
          <mxGeometry x="11.5" y="40" width="586" height="210" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-82" value="[S, B, d_m]" style="rounded=0;whiteSpace=wrap;html=1;" vertex="1" parent="2vjOk2sk5CpCFmqSpdgf-81">
          <mxGeometry x="186" y="134" width="194.5" height="36.5" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-83" value="_all_gather_base" style="text;html=1;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" vertex="1" parent="2vjOk2sk5CpCFmqSpdgf-81">
          <mxGeometry x="308.5" y="170.5" width="60" height="30" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-84" value="custom_fc" style="text;html=1;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" vertex="1" parent="2vjOk2sk5CpCFmqSpdgf-81">
          <mxGeometry x="288.5" y="84" width="60" height="30" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-85" value="" style="shape=flexArrow;endArrow=classic;startArrow=classic;html=1;rounded=0;" edge="1" parent="1">
          <mxGeometry width="100" height="100" relative="1" as="geometry">
            <mxPoint x="9120" y="-365" as="sourcePoint" />
            <mxPoint x="10140" y="-360" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-86" value="" style="shape=flexArrow;endArrow=classic;startArrow=classic;html=1;rounded=0;" edge="1" parent="1">
          <mxGeometry width="100" height="100" relative="1" as="geometry">
            <mxPoint x="9201" y="-1965.5" as="sourcePoint" />
            <mxPoint x="10000" y="-1965" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-87" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="2vjOk2sk5CpCFmqSpdgf-77" target="2vjOk2sk5CpCFmqSpdgf-3">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-88" value="apply_residual_connection_post_layernorm=False&lt;div&gt;所以使用layernorm之前的hidden_state作为residual&lt;/div&gt;" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" vertex="1" parent="1">
          <mxGeometry x="8626" y="-95" width="300" height="40" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-91" value="self.query_key_value(hidden_states)" style="text;html=1;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" vertex="1" parent="1">
          <mxGeometry x="9310" y="-470" width="220" height="20" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-92" value="" style="shape=flexArrow;endArrow=classic;startArrow=classic;html=1;rounded=0;" edge="1" parent="1">
          <mxGeometry width="100" height="100" relative="1" as="geometry">
            <mxPoint x="9110" y="-2540" as="sourcePoint" />
            <mxPoint x="9960" y="-2540" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-93" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;entryX=0.5;entryY=1;entryDx=0;entryDy=0;" edge="1" parent="1" source="2vjOk2sk5CpCFmqSpdgf-94" target="2vjOk2sk5CpCFmqSpdgf-98">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-94" value="[S, B, d_mlp / TP]" style="rounded=0;whiteSpace=wrap;html=1;" vertex="1" parent="1">
          <mxGeometry x="8904.75" y="-2860" width="194.5" height="36.5" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-95" value="RowPL,&amp;nbsp;sequence_parallel_enabled=True,&amp;nbsp;input_is_parallel=True" style="swimlane;whiteSpace=wrap;html=1;" vertex="1" parent="1">
          <mxGeometry x="8707.5" y="-3220" width="609" height="271" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-96" value="_reduce_scatter_along_first_dim" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" vertex="1" parent="2vjOk2sk5CpCFmqSpdgf-95">
          <mxGeometry x="295" y="50" width="200" height="30" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-97" value="&lt;div&gt;linear_with_grad_accumulation_and_async_allreduce(sequence_parallel_enabled=False)&lt;/div&gt;&lt;div&gt;Note: 在&lt;span style=&quot;background-color: initial;&quot;&gt;linear_with_grad_accumulation_and_async_allreduce中，&lt;/span&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;sequence_parallel_enabled的含义为在前向过程中，&lt;font color=&quot;#ff0000&quot;&gt;是否在fc前进行allgather&lt;/font&gt;，RowPL不需要，所以为False。&lt;/span&gt;&lt;/div&gt;" style="swimlane;whiteSpace=wrap;html=1;startSize=74;" vertex="1" parent="2vjOk2sk5CpCFmqSpdgf-95">
          <mxGeometry x="11.5" y="96" width="586" height="154" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-98" value="[S, B, d_m]" style="rounded=0;whiteSpace=wrap;html=1;" vertex="1" parent="2vjOk2sk5CpCFmqSpdgf-97">
          <mxGeometry x="185.75" y="84" width="194.5" height="36.5" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-99" value="custom_fc" style="text;html=1;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" vertex="1" parent="2vjOk2sk5CpCFmqSpdgf-97">
          <mxGeometry x="201.5" y="124" width="60" height="30" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-100" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="2vjOk2sk5CpCFmqSpdgf-8">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="9002" y="-3420" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-101" value="self.dense_h_to_4h" style="text;whiteSpace=wrap;" vertex="1" parent="1">
          <mxGeometry x="8578" y="-2680" width="139" height="26" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-102" value="SwiGLU" style="text;html=1;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" vertex="1" parent="1">
          <mxGeometry x="9021" y="-2810" width="60" height="30" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-103" value="self.dense_4h_to_h" style="text;whiteSpace=wrap;" vertex="1" parent="1">
          <mxGeometry x="8578" y="-3100" width="120" height="20" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-104" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;entryX=0.5;entryY=1;entryDx=0;entryDy=0;" edge="1" parent="1" source="2vjOk2sk5CpCFmqSpdgf-105" target="2vjOk2sk5CpCFmqSpdgf-108">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="9002" y="-3570" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-105" value="+" style="text;html=1;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=19;fontStyle=1" vertex="1" parent="1">
          <mxGeometry x="8972" y="-3460" width="60" height="30" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-106" value="dropout" style="text;html=1;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" vertex="1" parent="1">
          <mxGeometry x="9020" y="-3400" width="60" height="30" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-107" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;entryX=0.5;entryY=1;entryDx=0;entryDy=0;" edge="1" parent="1" source="2vjOk2sk5CpCFmqSpdgf-108" target="2vjOk2sk5CpCFmqSpdgf-129">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="9002" y="-3800" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-108" value="hidden_states [S/TP, B, d_m]" style="rounded=0;whiteSpace=wrap;html=1;" vertex="1" parent="1">
          <mxGeometry x="8826" y="-3620" width="352" height="40" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-109" value="_split_along_first_dim" style="text;whiteSpace=wrap;" vertex="1" parent="1">
          <mxGeometry x="9010" y="110" width="150" height="40" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-110" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;entryX=0.5;entryY=1;entryDx=0;entryDy=0;" edge="1" parent="1" source="2vjOk2sk5CpCFmqSpdgf-111" target="2vjOk2sk5CpCFmqSpdgf-66">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-111" value="hidden_states&amp;nbsp; [S, B, d_m]" style="rounded=0;whiteSpace=wrap;html=1;" vertex="1" parent="1">
          <mxGeometry x="8880" y="152" width="240" height="40" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-112" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;entryX=0.5;entryY=1;entryDx=0;entryDy=0;" edge="1" parent="1" source="2vjOk2sk5CpCFmqSpdgf-113" target="2vjOk2sk5CpCFmqSpdgf-111">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-113" value="hidden_states&amp;nbsp; [B, S, d_m]" style="rounded=0;whiteSpace=wrap;html=1;" vertex="1" parent="1">
          <mxGeometry x="8880" y="320" width="240" height="40" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-114" value="transpose(0, 1).contiguous()" style="text;whiteSpace=wrap;" vertex="1" parent="1">
          <mxGeometry x="9005" y="250" width="180" height="40" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-115" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=0;exitDx=0;exitDy=0;" edge="1" parent="1" source="2vjOk2sk5CpCFmqSpdgf-288">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="9000" y="750" as="targetPoint" />
            <mxPoint x="9000" y="1070" as="sourcePoint" />
          </mxGeometry>
        </mxCell>
        <UserObject label="&lt;div style=&quot;color: #657b83;background-color: #fdf6e3;font-family: Menlo, Monaco, &#39;Courier New&#39;, monospace;font-weight: normal;font-size: 12px;line-height: 18px;white-space: pre;&quot;&gt;&lt;div&gt;&lt;span style=&quot;color: #657b83;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #268bd2;&quot;&gt;input_mask&lt;/span&gt;&lt;span style=&quot;color: #657b83;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #859900;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #657b83;&quot;&gt; (input_ &lt;/span&gt;&lt;span style=&quot;color: #859900;&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span style=&quot;color: #657b83;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #268bd2;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #657b83;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #268bd2;&quot;&gt;vocab_start_index&lt;/span&gt;&lt;span style=&quot;color: #657b83;&quot;&gt;) &lt;/span&gt;&lt;span style=&quot;color: #859900;&quot;&gt;|&lt;/span&gt;&lt;span style=&quot;color: #657b83;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #dc322f;&quot;&gt;\&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #657b83;&quot;&gt;                         (input_ &lt;/span&gt;&lt;span style=&quot;color: #859900;&quot;&gt;&amp;gt;=&lt;/span&gt;&lt;span style=&quot;color: #657b83;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #268bd2;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #657b83;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #268bd2;&quot;&gt;vocab_end_index&lt;/span&gt;&lt;span style=&quot;color: #657b83;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #657b83;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #93a1a1;font-style: italic;&quot;&gt;# Mask the input.&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #657b83;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #268bd2;&quot;&gt;masked_input&lt;/span&gt;&lt;span style=&quot;color: #657b83;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #859900;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #657b83;&quot;&gt; input_.clone() &lt;/span&gt;&lt;span style=&quot;color: #859900;&quot;&gt;-&lt;/span&gt;&lt;span style=&quot;color: #657b83;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #268bd2;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #657b83;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #268bd2;&quot;&gt;vocab_start_index&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #657b83;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #268bd2;&quot;&gt;masked_input&lt;/span&gt;&lt;span style=&quot;color: #657b83;&quot;&gt;[&lt;/span&gt;&lt;span style=&quot;color: #268bd2;&quot;&gt;input_mask&lt;/span&gt;&lt;span style=&quot;color: #657b83;&quot;&gt;] &lt;/span&gt;&lt;span style=&quot;color: #859900;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #657b83;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #d33682;&quot;&gt;0 #避免查表越界&lt;/span&gt;&lt;/div&gt;&lt;/div&gt;" link="&lt;div style=&quot;color: #657b83;background-color: #fdf6e3;font-family: Menlo, Monaco, &#39;Courier New&#39;, monospace;font-weight: normal;font-size: 12px;line-height: 18px;white-space: pre;&quot;&gt;&lt;div&gt;&lt;span style=&quot;color: #657b83;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #268bd2;&quot;&gt;input_mask&lt;/span&gt;&lt;span style=&quot;color: #657b83;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #859900;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #657b83;&quot;&gt; (input_ &lt;/span&gt;&lt;span style=&quot;color: #859900;&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span style=&quot;color: #657b83;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #268bd2;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #657b83;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #268bd2;&quot;&gt;vocab_start_index&lt;/span&gt;&lt;span style=&quot;color: #657b83;&quot;&gt;) &lt;/span&gt;&lt;span style=&quot;color: #859900;&quot;&gt;|&lt;/span&gt;&lt;span style=&quot;color: #657b83;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #dc322f;&quot;&gt;\&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #657b83;&quot;&gt;                         (input_ &lt;/span&gt;&lt;span style=&quot;color: #859900;&quot;&gt;&amp;gt;=&lt;/span&gt;&lt;span style=&quot;color: #657b83;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #268bd2;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #657b83;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #268bd2;&quot;&gt;vocab_end_index&lt;/span&gt;&lt;span style=&quot;color: #657b83;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #657b83;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #93a1a1;font-style: italic;&quot;&gt;# Mask the input.&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #657b83;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #268bd2;&quot;&gt;masked_input&lt;/span&gt;&lt;span style=&quot;color: #657b83;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #859900;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #657b83;&quot;&gt; input_.clone() &lt;/span&gt;&lt;span style=&quot;color: #859900;&quot;&gt;-&lt;/span&gt;&lt;span style=&quot;color: #657b83;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #268bd2;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #657b83;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #268bd2;&quot;&gt;vocab_start_index&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #657b83;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #268bd2;&quot;&gt;masked_input&lt;/span&gt;&lt;span style=&quot;color: #657b83;&quot;&gt;[&lt;/span&gt;&lt;span style=&quot;color: #268bd2;&quot;&gt;input_mask&lt;/span&gt;&lt;span style=&quot;color: #657b83;&quot;&gt;] &lt;/span&gt;&lt;span style=&quot;color: #859900;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #657b83;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #d33682;&quot;&gt;0&lt;/span&gt;&lt;/div&gt;&lt;/div&gt;" id="2vjOk2sk5CpCFmqSpdgf-117">
          <mxCell style="text;whiteSpace=wrap;html=1;" vertex="1" parent="1">
            <mxGeometry x="9019" y="790" width="510" height="110" as="geometry" />
          </mxCell>
        </UserObject>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-118" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;entryX=0.5;entryY=1;entryDx=0;entryDy=0;" edge="1" parent="1" source="2vjOk2sk5CpCFmqSpdgf-119" target="2vjOk2sk5CpCFmqSpdgf-121">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-119" value="masked_input [B, S]" style="rounded=0;whiteSpace=wrap;html=1;" vertex="1" parent="1">
          <mxGeometry x="8880" y="710" width="240" height="40" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-120" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;entryX=0.5;entryY=1;entryDx=0;entryDy=0;" edge="1" parent="1" source="2vjOk2sk5CpCFmqSpdgf-121" target="2vjOk2sk5CpCFmqSpdgf-124">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-121" value="embedding [B, S, d_m]" style="rounded=0;whiteSpace=wrap;html=1;" vertex="1" parent="1">
          <mxGeometry x="8880" y="600" width="240" height="40" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-122" value="F.embedding" style="text;html=1;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" vertex="1" parent="1">
          <mxGeometry x="9010" y="660" width="60" height="30" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-123" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;entryX=0.5;entryY=1;entryDx=0;entryDy=0;" edge="1" parent="1" source="2vjOk2sk5CpCFmqSpdgf-124" target="2vjOk2sk5CpCFmqSpdgf-113">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-124" value="embedding [B, S, d_m]" style="rounded=0;whiteSpace=wrap;html=1;" vertex="1" parent="1">
          <mxGeometry x="8880" y="520" width="240" height="40" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-125" value="&lt;div style=&quot;color: #657b83;background-color: #fdf6e3;font-family: Menlo, Monaco, &#39;Courier New&#39;, monospace;font-weight: normal;font-size: 12px;line-height: 18px;white-space: pre;&quot;&gt;&lt;div&gt;&lt;span style=&quot;color: #268bd2;&quot;&gt;output_parallel&lt;/span&gt;&lt;span style=&quot;color: #657b83;&quot;&gt;[&lt;/span&gt;&lt;span style=&quot;color: #268bd2;&quot;&gt;input_mask&lt;/span&gt;&lt;span style=&quot;color: #657b83;&quot;&gt;, :] &lt;/span&gt;&lt;span style=&quot;color: #859900;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #657b83;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #d33682;&quot;&gt;0.0&lt;/span&gt;&lt;/div&gt;&lt;/div&gt;" style="text;whiteSpace=wrap;html=1;" vertex="1" parent="1">
          <mxGeometry x="9026" y="565" width="290" height="40" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-126" value="all_reduce" style="text;html=1;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" vertex="1" parent="1">
          <mxGeometry x="9010" y="460" width="60" height="30" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-127" value="Q：这个all_reduce可否跟Embeeding的&lt;span style=&quot;text-align: left;&quot;&gt;_split_along_first_dim抵消？&lt;/span&gt;&lt;div&gt;&lt;span style=&quot;text-align: left;&quot;&gt;A：不可以，这里做all_reduce是因为每个tp字典不完整；而后面的split是在S维度上做split，两者不是一回事；绝不能抵消&lt;/span&gt;&lt;/div&gt;" style="text;html=1;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" vertex="1" parent="1">
          <mxGeometry x="9151" y="500" width="379" height="40" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-128" value="self.final_layernorm(hidden_states)" style="text;whiteSpace=wrap;" vertex="1" parent="1">
          <mxGeometry x="9011" y="-3810" width="220" height="40" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-129" value="hidden_states [S/TP, B, d_m]" style="rounded=0;whiteSpace=wrap;html=1;" vertex="1" parent="1">
          <mxGeometry x="8826" y="-3880" width="352" height="40" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-130" value="VocabParallelEmbedding" style="swimlane;whiteSpace=wrap;html=1;" vertex="1" parent="1">
          <mxGeometry x="8590" y="400" width="1170" height="570" as="geometry">
            <mxRectangle x="8590" y="400" width="170" height="30" as="alternateBounds" />
          </mxGeometry>
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-131" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;entryX=0.5;entryY=1;entryDx=0;entryDy=0;" edge="1" parent="1" source="2vjOk2sk5CpCFmqSpdgf-98" target="2vjOk2sk5CpCFmqSpdgf-8">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="9002" y="-3270" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-132" value="ColPL,&amp;nbsp;sequence_parallel_enabled=True,&amp;nbsp;input_is_parallel=True" style="swimlane;whiteSpace=wrap;html=1;" vertex="1" parent="1">
          <mxGeometry x="8705.5" y="-2770" width="609" height="271" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-133" value="&lt;div&gt;linear_with_grad_accumulation_and_async_allreduce(sequence_parallel_enabled=True)&lt;/div&gt;&lt;div&gt;Note: 在&lt;span style=&quot;background-color: initial;&quot;&gt;linear_with_grad_accumulation_and_async_allreduce中，&lt;/span&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;sequence_parallel_enabled的含义为在前向过程中，&lt;font color=&quot;#ff0000&quot;&gt;是否在fc前进行allgather&lt;/font&gt;，ColPL需要，所以为True&lt;/span&gt;&lt;/div&gt;" style="swimlane;whiteSpace=wrap;html=1;startSize=49;" vertex="1" parent="2vjOk2sk5CpCFmqSpdgf-132">
          <mxGeometry x="11.5" y="40" width="586" height="210" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-134" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="2vjOk2sk5CpCFmqSpdgf-133" source="2vjOk2sk5CpCFmqSpdgf-135">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="283.25" y="-90" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-135" value="[S, B, d_m]" style="rounded=0;whiteSpace=wrap;html=1;" vertex="1" parent="2vjOk2sk5CpCFmqSpdgf-133">
          <mxGeometry x="186" y="134" width="194.5" height="36.5" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-136" value="_all_gather_base" style="text;html=1;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" vertex="1" parent="2vjOk2sk5CpCFmqSpdgf-133">
          <mxGeometry x="308.5" y="170.5" width="60" height="30" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-137" value="custom_fc" style="text;html=1;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" vertex="1" parent="2vjOk2sk5CpCFmqSpdgf-133">
          <mxGeometry x="288.5" y="84" width="60" height="30" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-138" value="TransformerLanguageModel(add_encoder=True, add_decoder-False, add_pooler=False, pre_process=True, post_process=True, norm_type=rmsnorm, decoder_attn_mask_type=AttnMaskType.causal)" style="swimlane;whiteSpace=wrap;html=1;" vertex="1" parent="1">
          <mxGeometry x="7880" y="-4170" width="2040" height="5410" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-296" value="&lt;b&gt;rotary_pos_emb&lt;/b&gt;&amp;nbsp;[S, 1, 1, d_h]" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="2vjOk2sk5CpCFmqSpdgf-138">
          <mxGeometry x="293" y="2802.5" width="230" height="50" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-298" value="self.rotary_pos_emb(position_ids)&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;div&gt;Note：这里有个&lt;b&gt;&lt;font color=&quot;#ff0818&quot;&gt;BUG&lt;/font&gt;&lt;/b&gt;；代码中这里没有用到position_ids.而是self.rotary_pos_emb(seq_length)，&lt;/div&gt;&lt;div&gt;所以reset_position_ids实际上是没有起作用的&lt;/div&gt;&lt;div&gt;github上已经有人提了issue：https://github.com/NVIDIA/Megatron-LM/issues/453&lt;br&gt;&lt;/div&gt;&lt;/div&gt;" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" vertex="1" parent="2vjOk2sk5CpCFmqSpdgf-138">
          <mxGeometry x="-77" y="2790" width="530" height="100" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-301" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="2vjOk2sk5CpCFmqSpdgf-138" source="2vjOk2sk5CpCFmqSpdgf-291" target="2vjOk2sk5CpCFmqSpdgf-296">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-291" value="&lt;b&gt;position_ids&lt;/b&gt; [B, S]" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="2vjOk2sk5CpCFmqSpdgf-138">
          <mxGeometry x="-320" y="2802.5" width="235" height="50" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-315" value="@gaotianlin" style="text;html=1;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=18;fontStyle=1;fontColor=#00FFFF;" vertex="1" parent="2vjOk2sk5CpCFmqSpdgf-138">
          <mxGeometry x="1830" y="2130" width="60" height="30" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-139" value="23" style="rounded=0;whiteSpace=wrap;html=1;" vertex="1" parent="1">
          <mxGeometry x="8481" y="1900" width="63" height="50" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-140" value="&lt;span style=&quot;color: rgb(0, 0, 0); font-family: Helvetica; font-size: 18px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: 400; letter-spacing: normal; orphans: 2; text-align: center; text-indent: 0px; text-transform: none; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; white-space: normal; background-color: rgb(251, 251, 251); text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial; float: none; display: inline !important;&quot;&gt;doc_idx&lt;/span&gt;" style="text;whiteSpace=wrap;html=1;fontSize=18;" vertex="1" parent="1">
          <mxGeometry x="8264" y="1910" width="70" height="40" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-142" value="724" style="rounded=0;whiteSpace=wrap;html=1;" vertex="1" parent="1">
          <mxGeometry x="8544" y="1900" width="63" height="50" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-143" value="1" style="rounded=0;whiteSpace=wrap;html=1;" vertex="1" parent="1">
          <mxGeometry x="8607" y="1900" width="63" height="50" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-144" value="64" style="rounded=0;whiteSpace=wrap;html=1;" vertex="1" parent="1">
          <mxGeometry x="8670" y="1900" width="63" height="50" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-148" value="18" style="rounded=0;whiteSpace=wrap;html=1;" vertex="1" parent="1">
          <mxGeometry x="8733" y="1900" width="63" height="50" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-155" value="" style="rounded=0;whiteSpace=wrap;html=1;" vertex="1" parent="1">
          <mxGeometry x="9218" y="2006.65" width="908" height="60" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-157" value="" style="shape=flexArrow;endArrow=classic;html=1;rounded=0;entryX=0.287;entryY=-0.087;entryDx=0;entryDy=0;entryPerimeter=0;" edge="1" parent="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="9340.9" y="1900" as="sourcePoint" />
            <mxPoint x="9340.496" y="1985.6499999999996" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-158" value="ptr + offset&lt;div&gt;doc起始地址+doc内偏移&lt;/div&gt;" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" vertex="1" connectable="0" parent="2vjOk2sk5CpCFmqSpdgf-157">
          <mxGeometry x="-0.5961" y="4" relative="1" as="geometry">
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-172" value="doc 0" style="rounded=0;whiteSpace=wrap;html=1;" vertex="1" parent="1">
          <mxGeometry x="9218" y="2006.65" width="120" height="60" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-173" value="doc 1" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;" vertex="1" parent="1">
          <mxGeometry x="9337.5" y="2006.65" width="120" height="60" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-174" value="doc 23" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;" vertex="1" parent="1">
          <mxGeometry x="9612" y="2006.65" width="120" height="60" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-175" value="doc 724" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#e1d5e7;strokeColor=#9673a6;" vertex="1" parent="1">
          <mxGeometry x="9906" y="2006.65" width="120" height="60" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-181" value="177" style="rounded=0;whiteSpace=wrap;html=1;" vertex="1" parent="1">
          <mxGeometry x="8418" y="1900" width="63" height="50" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-182" value="..." style="text;html=1;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=21;fontStyle=1" vertex="1" parent="1">
          <mxGeometry x="8358" y="1915" width="60" height="30" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-183" value="..." style="text;html=1;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=21;fontStyle=1" vertex="1" parent="1">
          <mxGeometry x="8795" y="1915" width="60" height="30" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-184" value="offset&lt;div&gt;100&lt;/div&gt;" style="rounded=0;whiteSpace=wrap;html=1;" vertex="1" parent="1">
          <mxGeometry x="8418" y="1790" width="86" height="50" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-185" value="&lt;span style=&quot;color: rgb(0, 0, 0); font-family: Helvetica; font-size: 18px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: 400; letter-spacing: normal; orphans: 2; text-align: center; text-indent: 0px; text-transform: none; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; white-space: normal; background-color: rgb(251, 251, 251); text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial; float: none; display: inline !important;&quot;&gt;sample_idx&lt;/span&gt;" style="text;whiteSpace=wrap;html=1;fontSize=18;" vertex="1" parent="1">
          <mxGeometry x="8264" y="1750" width="70" height="40" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-190" value="doc_index&lt;div&gt;221&lt;/div&gt;" style="rounded=0;whiteSpace=wrap;html=1;" vertex="1" parent="1">
          <mxGeometry x="8418" y="1740" width="86" height="50" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-191" value="..." style="text;html=1;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=21;fontStyle=1" vertex="1" parent="1">
          <mxGeometry x="8358" y="1755" width="60" height="30" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-192" value="..." style="text;html=1;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=21;fontStyle=1" vertex="1" parent="1">
          <mxGeometry x="8795" y="1755" width="60" height="30" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-193" value="offset&lt;div&gt;988&lt;/div&gt;" style="rounded=0;whiteSpace=wrap;html=1;" vertex="1" parent="1">
          <mxGeometry x="8504" y="1790" width="86" height="50" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-194" value="doc_index&lt;div&gt;223&lt;/div&gt;" style="rounded=0;whiteSpace=wrap;html=1;" vertex="1" parent="1">
          <mxGeometry x="8504" y="1740" width="86" height="50" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-195" value="offset" style="rounded=0;whiteSpace=wrap;html=1;" vertex="1" parent="1">
          <mxGeometry x="8590" y="1790" width="86" height="50" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-196" value="doc_index" style="rounded=0;whiteSpace=wrap;html=1;" vertex="1" parent="1">
          <mxGeometry x="8590" y="1740" width="86" height="50" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-197" value="offset" style="rounded=0;whiteSpace=wrap;html=1;" vertex="1" parent="1">
          <mxGeometry x="8676" y="1790" width="86" height="50" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-198" value="doc_index" style="rounded=0;whiteSpace=wrap;html=1;" vertex="1" parent="1">
          <mxGeometry x="8676" y="1740" width="86" height="50" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-201" value="221" style="text;html=1;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" vertex="1" parent="1">
          <mxGeometry x="8464" y="1870" width="60" height="30" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-202" value="223" style="text;html=1;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" vertex="1" parent="1">
          <mxGeometry x="8594" y="1870" width="60" height="30" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-203" value="&lt;div style=&quot;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;indexed_dataset.get(doc_id = 23, offset = 100, length = None)；开头的doc可能用了结尾的一部分，此时length为None，意为从offset开始，取到文档的结尾&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 17px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;indexed_dataset.get&lt;/span&gt;(doc_id = 724, offset = 0, length=None) ；中间的doc一定是完整的一段document，从doc开头(offset=0)取到结尾(length=None)&lt;/div&gt;&lt;div style=&quot;font-size: 17px;&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 17px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;indexed_dataset.get&lt;/span&gt;(doc_id = 1, offset = 0, length = 988 + 1)；结尾doc的可能只用了开头的一部分，从doc开头(offset=0)取到凑够seq_length&lt;/div&gt;&lt;div style=&quot;font-size: 17px;&quot;&gt;Note:最后一个doc多取一个，为了错位生成next_token_prediction&lt;/div&gt;&lt;div style=&quot;font-size: 17px;&quot;&gt;&lt;br style=&quot;font-size: 17px;&quot;&gt;&lt;/div&gt;" style="text;html=1;align=left;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=17;" vertex="1" parent="1">
          <mxGeometry x="7794.5" y="2030" width="1220" height="58" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-204" value="&lt;span style=&quot;color: rgb(0, 0, 0); font-family: Helvetica; font-size: 18px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: 400; letter-spacing: normal; orphans: 2; text-align: center; text-indent: 0px; text-transform: none; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; white-space: normal; background-color: rgb(251, 251, 251); text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial; float: none; display: inline !important;&quot;&gt;self._index&lt;/span&gt;" style="text;whiteSpace=wrap;html=1;fontSize=18;" vertex="1" parent="1">
          <mxGeometry x="9190" y="1750" width="108" height="40" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-205" value="size" style="rounded=0;whiteSpace=wrap;html=1;" vertex="1" parent="1">
          <mxGeometry x="9298" y="1790" width="86" height="50" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-206" value="ptr" style="rounded=0;whiteSpace=wrap;html=1;" vertex="1" parent="1">
          <mxGeometry x="9298" y="1740" width="86" height="50" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-207" value="size&lt;div&gt;1010&lt;/div&gt;" style="rounded=0;whiteSpace=wrap;html=1;" vertex="1" parent="1">
          <mxGeometry x="9384" y="1790" width="86" height="50" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-208" value="ptr" style="rounded=0;whiteSpace=wrap;html=1;" vertex="1" parent="1">
          <mxGeometry x="9384" y="1740" width="86" height="50" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-209" value="size&lt;div&gt;112&lt;/div&gt;" style="rounded=0;whiteSpace=wrap;html=1;" vertex="1" parent="1">
          <mxGeometry x="9547" y="1790" width="86" height="50" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-210" value="ptr" style="rounded=0;whiteSpace=wrap;html=1;" vertex="1" parent="1">
          <mxGeometry x="9547" y="1740" width="86" height="50" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-211" value="size&lt;div&gt;3096&lt;/div&gt;" style="rounded=0;whiteSpace=wrap;html=1;" vertex="1" parent="1">
          <mxGeometry x="9713" y="1790" width="86" height="50" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-212" value="ptr" style="rounded=0;whiteSpace=wrap;html=1;" vertex="1" parent="1">
          <mxGeometry x="9713" y="1740" width="86" height="50" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-214" value="&lt;span style=&quot;color: rgb(0, 0, 0); font-family: Helvetica; font-size: 18px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: 400; letter-spacing: normal; orphans: 2; text-align: center; text-indent: 0px; text-transform: none; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; white-space: normal; background-color: rgb(251, 251, 251); text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial; float: none; display: inline !important;&quot;&gt;doc在bin中的起始地址&lt;/span&gt;" style="text;whiteSpace=wrap;html=1;fontSize=18;" vertex="1" parent="1">
          <mxGeometry x="9907" y="1755" width="193" height="35" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-215" value="&lt;span style=&quot;color: rgb(0, 0, 0); font-family: Helvetica; font-size: 18px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: 400; letter-spacing: normal; orphans: 2; text-align: center; text-indent: 0px; text-transform: none; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; white-space: normal; background-color: rgb(251, 251, 251); text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial; float: none; display: inline !important;&quot;&gt;doc在bin中的长度&lt;/span&gt;" style="text;whiteSpace=wrap;html=1;fontSize=18;" vertex="1" parent="1">
          <mxGeometry x="9907" y="1797.5" width="193" height="35" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-217" value="" style="shape=flexArrow;endArrow=classic;html=1;rounded=0;entryX=0.287;entryY=-0.087;entryDx=0;entryDy=0;entryPerimeter=0;" edge="1" parent="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="9662.4" y="1900" as="sourcePoint" />
            <mxPoint x="9661.996" y="1985.6499999999996" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-218" value="ptr + offset&lt;div&gt;doc起始地址+doc内偏移&lt;/div&gt;" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" vertex="1" connectable="0" parent="2vjOk2sk5CpCFmqSpdgf-217">
          <mxGeometry x="-0.5961" y="4" relative="1" as="geometry">
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-222" value="..." style="text;html=1;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=21;fontStyle=1" vertex="1" parent="1">
          <mxGeometry x="9478" y="1767.5" width="60" height="30" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-223" value="..." style="text;html=1;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=21;fontStyle=1" vertex="1" parent="1">
          <mxGeometry x="9642" y="1767.5" width="60" height="30" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-224" value="..." style="text;html=1;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=21;fontStyle=1" vertex="1" parent="1">
          <mxGeometry x="9807" y="1767.5" width="60" height="30" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-231" value="" style="shape=flexArrow;endArrow=classic;startArrow=classic;html=1;rounded=0;" edge="1" parent="1">
          <mxGeometry width="100" height="100" relative="1" as="geometry">
            <mxPoint x="9677" y="1970" as="sourcePoint" />
            <mxPoint x="9737" y="1970" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-233" value="&lt;span style=&quot;font-size: 11px; text-wrap: nowrap; background-color: rgb(255, 255, 255);&quot;&gt;length=size-offset&lt;/span&gt;&lt;div&gt;&lt;span style=&quot;font-size: 11px; text-wrap: nowrap; background-color: rgb(255, 255, 255);&quot;&gt;=112-100=12&lt;/span&gt;&lt;/div&gt;" style="text;html=1;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" vertex="1" parent="1">
          <mxGeometry x="9702" y="1976.65" width="60" height="30" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-234" value="" style="shape=flexArrow;endArrow=classic;html=1;rounded=0;entryX=0.287;entryY=-0.087;entryDx=0;entryDy=0;entryPerimeter=0;" edge="1" parent="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="9907.4" y="1900" as="sourcePoint" />
            <mxPoint x="9906.996" y="1985.6499999999996" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-235" value="ptr + offset&lt;div&gt;doc起始地址+doc内偏移&lt;/div&gt;" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" vertex="1" connectable="0" parent="2vjOk2sk5CpCFmqSpdgf-234">
          <mxGeometry x="-0.5961" y="4" relative="1" as="geometry">
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-236" value="" style="shape=flexArrow;endArrow=classic;startArrow=classic;html=1;rounded=0;" edge="1" parent="1">
          <mxGeometry width="100" height="100" relative="1" as="geometry">
            <mxPoint x="9927" y="1970" as="sourcePoint" />
            <mxPoint x="10027" y="1970" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-237" value="&lt;span style=&quot;font-size: 11px; text-wrap: nowrap; background-color: rgb(255, 255, 255);&quot;&gt;length=size=3096&lt;/span&gt;" style="text;html=1;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" vertex="1" parent="1">
          <mxGeometry x="9932" y="1976.65" width="60" height="30" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-243" value="" style="shape=flexArrow;endArrow=classic;startArrow=classic;html=1;rounded=0;" edge="1" parent="1">
          <mxGeometry width="100" height="100" relative="1" as="geometry">
            <mxPoint x="9359" y="1960" as="sourcePoint" />
            <mxPoint x="9417" y="1960" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-244" value="&lt;span style=&quot;font-size: 11px; text-wrap: nowrap; background-color: rgb(255, 255, 255);&quot;&gt;length=98&lt;b&gt;9&lt;/b&gt;&lt;/span&gt;" style="text;html=1;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" vertex="1" parent="1">
          <mxGeometry x="9364" y="1966.65" width="60" height="30" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-245" value="" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;" vertex="1" parent="1">
          <mxGeometry x="9417" y="2006.65" width="40.5" height="60" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-246" value="" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;" vertex="1" parent="1">
          <mxGeometry x="9607" y="2006.65" width="45" height="60" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-248" value="doc 1 前988个token" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;" vertex="1" parent="1">
          <mxGeometry x="8855" y="2066.65" width="75" height="60" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-249" value="doc 23后12个token" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;" vertex="1" parent="1">
          <mxGeometry x="8975" y="1961.65" width="80" height="60" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-250" value="完整的doc 724&lt;div&gt;3096 token&lt;/div&gt;" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#e1d5e7;strokeColor=#9673a6;" vertex="1" parent="1">
          <mxGeometry x="8948" y="2028" width="120" height="60" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-255" value="12 + 3096 + 989 = 4097 tokens = &lt;font color=&quot;#ff0000&quot;&gt;S + 1&lt;/font&gt;" style="text;html=1;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=14;fontStyle=1" vertex="1" parent="1">
          <mxGeometry x="7917" y="2225" width="300" height="50" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-257" value="doc 1 前989个token" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;" vertex="1" parent="1">
          <mxGeometry x="8429" y="2220" width="75" height="60" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-258" value="doc 23后12个token" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;" vertex="1" parent="1">
          <mxGeometry x="8229" y="2220" width="80" height="60" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-259" value="完整的doc 724&lt;div&gt;3096 token&lt;/div&gt;" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#e1d5e7;strokeColor=#9673a6;" vertex="1" parent="1">
          <mxGeometry x="8309" y="2220" width="120" height="60" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-260" value="" style="shape=flexArrow;endArrow=classic;html=1;rounded=0;" edge="1" parent="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="8327" y="2120" as="sourcePoint" />
            <mxPoint x="8327" y="2210" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-262" value="np.concatenate" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" vertex="1" connectable="0" parent="2vjOk2sk5CpCFmqSpdgf-260">
          <mxGeometry x="-0.4741" y="-7" relative="1" as="geometry">
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-263" value="" style="shape=flexArrow;endArrow=classic;startArrow=classic;html=1;rounded=0;" edge="1" parent="1">
          <mxGeometry width="100" height="100" relative="1" as="geometry">
            <mxPoint x="9077" y="2036.15" as="sourcePoint" />
            <mxPoint x="9187" y="2036.15" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-264" value="" style="shape=flexArrow;endArrow=classic;html=1;rounded=0;" edge="1" parent="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="8327" y="2320" as="sourcePoint" />
            <mxPoint x="8327" y="2410" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-266" value="重复B次" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" vertex="1" connectable="0" parent="2vjOk2sk5CpCFmqSpdgf-264">
          <mxGeometry x="-0.2074" y="4" relative="1" as="geometry">
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-271" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;entryX=0.5;entryY=0;entryDx=0;entryDy=0;" edge="1" parent="1" source="2vjOk2sk5CpCFmqSpdgf-268" target="2vjOk2sk5CpCFmqSpdgf-269">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-272" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="2vjOk2sk5CpCFmqSpdgf-268" target="2vjOk2sk5CpCFmqSpdgf-270">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-268" value="tokens_ = [B, S + 1]" style="rounded=0;whiteSpace=wrap;html=1;" vertex="1" parent="1">
          <mxGeometry x="8207" y="2450" width="240" height="50" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-276" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="2vjOk2sk5CpCFmqSpdgf-269">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="8189" y="2710" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-269" value="&lt;b&gt;tokens&lt;/b&gt; = tokens_[, :-1],&amp;nbsp; &amp;nbsp;[B, S]" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="1">
          <mxGeometry x="8069" y="2578" width="240" height="50" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-270" value="&lt;b&gt;labels&lt;/b&gt; = tokens_[, 1:],&amp;nbsp; [B, S]" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="1">
          <mxGeometry x="8367" y="2578" width="240" height="50" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-275" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="2vjOk2sk5CpCFmqSpdgf-273">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="7821" y="2710" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-273" value="args.reset_position_ids? 每个doc的postion_ids是否从0开始&lt;div&gt;args.reset_attention_masks? 每个doc的mask是否为独立的上三角矩阵&lt;/div&gt;&lt;div&gt;args.eod_mask_loss? eod符号的loss是否无需计算&lt;/div&gt;" style="text;html=1;align=left;verticalAlign=middle;whiteSpace=wrap;rounded=0;" vertex="1" parent="1">
          <mxGeometry x="7627" y="2460" width="390" height="130" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-287" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="2vjOk2sk5CpCFmqSpdgf-278">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="8005" y="2940" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-278" value="数据集中绝大部分的doc长度&amp;lt; 100(见右图），一个Sequence一般由多个doc组成(packing)，doc之间通过sod(==1), eod(==2)分割。&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;若&lt;span style=&quot;background-color: initial;&quot;&gt;reset_position_ids&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;reset_attention_masks为True，则一个Sequence的不同doc之间的position_ids是独立的，从0开始的；不同的doc的mask也是独立的，attention_mask包含多个独立的上三角矩阵。&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;若eod_mask_loss为True，则loss_mask中eod对应位置为0，其余位置为1；在最终计算loss时，eod未知的loss会被mask掉。&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;span style=&quot;&quot;&gt;以alpaca数据集为例，可能预处理的时候没有加--append-eod参数，所以每个doc只有sod没有结尾的eod。在eod缺失的情况下&lt;/span&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;reset_position_ids 和&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;reset_attention_masks取什么值，都不会影响position_id和attention_mask；loss_mask因为没有eod，也为全1.&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;/div&gt;" style="text;html=1;align=left;verticalAlign=middle;whiteSpace=wrap;rounded=0;" vertex="1" parent="1">
          <mxGeometry x="7720" y="2730" width="570" height="180" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-279" value="预训练只有next token prediction这一个任务" style="text;html=1;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" vertex="1" parent="1">
          <mxGeometry x="8327" y="2510" width="250" height="10" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-280" value="https://www.graphcore.ai/posts/packedbert-how-to-accelerate-nlp-tasks-for-transformers-with-packing" style="shape=image;verticalLabelPosition=bottom;labelBackgroundColor=default;verticalAlign=top;aspect=fixed;imageAspect=0;image=https://www.graphcore.ai/hs-fs/hubfs/39ds_hist%20(1).png?width=1210&amp;height=712&amp;name=39ds_hist%20(1).png;" vertex="1" parent="1">
          <mxGeometry x="8667" y="2450" width="819" height="481.85" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-282" value="&lt;b&gt;attention_mask&lt;/b&gt; [1, S, S] or [B, S, S]&lt;div&gt;reset_attention_mask为False时，每个B的mask都是相同的上三角矩阵，可共享&lt;/div&gt;" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="1">
          <mxGeometry x="7667" y="2955" width="230" height="50" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-283" value="&lt;b&gt;position_ids&lt;/b&gt; [B, S]&lt;div&gt;&lt;span style=&quot;text-align: left;&quot;&gt;reset_position_ids为False时，也可共享，但代码中目前还没做优化&lt;/span&gt;&lt;br&gt;&lt;/div&gt;" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="1">
          <mxGeometry x="7907" y="2955" width="230" height="50" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-284" value="&lt;b&gt;loss_mask&lt;/b&gt; [B, S]&lt;div&gt;eod_mask_loss为False时，也可共享，但代码还没有优化&lt;/div&gt;" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#f8cecc;strokeColor=#b85450;" vertex="1" parent="1">
          <mxGeometry x="8149" y="2955" width="230" height="50" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-288" value="&lt;b&gt;tokens&lt;/b&gt;&amp;nbsp;[B, S]" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="1">
          <mxGeometry x="8881" y="1270" width="240" height="50" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-289" value="&lt;b&gt;labels&lt;/b&gt;&amp;nbsp; [B, S]" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="1">
          <mxGeometry x="7517.5" y="100" width="240" height="50" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-294" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="2vjOk2sk5CpCFmqSpdgf-290" target="2vjOk2sk5CpCFmqSpdgf-56">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-290" value="&lt;b&gt;attention_mask&lt;/b&gt; [1, 1, S, S] or [1, B, S, S]" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="1">
          <mxGeometry x="7557" y="-1640" width="230" height="50" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-292" value="&lt;b&gt;loss_mask&lt;/b&gt; [B, S]" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#f8cecc;strokeColor=#b85450;" vertex="1" parent="1">
          <mxGeometry x="7675" y="-4530" width="230" height="50" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-293" value="GPTDataset" style="swimlane;whiteSpace=wrap;html=1;" vertex="1" parent="1">
          <mxGeometry x="7757" y="1673" width="1360" height="667" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-304" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;entryX=0.5;entryY=1;entryDx=0;entryDy=0;" edge="1" parent="1" source="2vjOk2sk5CpCFmqSpdgf-42" target="2vjOk2sk5CpCFmqSpdgf-49">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-305" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="2vjOk2sk5CpCFmqSpdgf-51" target="2vjOk2sk5CpCFmqSpdgf-53">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-306" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="2vjOk2sk5CpCFmqSpdgf-296" target="2vjOk2sk5CpCFmqSpdgf-47">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-312" value="IndexedDataset" style="swimlane;whiteSpace=wrap;html=1;" vertex="1" parent="1">
          <mxGeometry x="9147" y="1673" width="1060" height="667" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-213" value="doc 0" style="text;html=1;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" vertex="1" parent="2vjOk2sk5CpCFmqSpdgf-312">
          <mxGeometry x="160" y="44" width="60" height="30" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-219" value="doc 1" style="text;html=1;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" vertex="1" parent="2vjOk2sk5CpCFmqSpdgf-312">
          <mxGeometry x="249" y="44" width="60" height="30" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-220" value="doc 23" style="text;html=1;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" vertex="1" parent="2vjOk2sk5CpCFmqSpdgf-312">
          <mxGeometry x="417" y="44" width="60" height="30" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-221" value="doc 724" style="text;html=1;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" vertex="1" parent="2vjOk2sk5CpCFmqSpdgf-312">
          <mxGeometry x="584.5" y="44" width="60" height="30" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-313" value="数据预处理：pretrain_llama.py: get_batch(...)" style="swimlane;whiteSpace=wrap;html=1;" vertex="1" parent="1">
          <mxGeometry x="7557" y="1640" width="2670" height="1400" as="geometry" />
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-314" value="" style="shape=flexArrow;endArrow=classic;html=1;rounded=0;" edge="1" parent="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="8939.82" y="1590" as="sourcePoint" />
            <mxPoint x="8939.82" y="1460" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="2vjOk2sk5CpCFmqSpdgf-316" value="" style="shape=flexArrow;endArrow=classic;startArrow=classic;html=1;rounded=0;" edge="1" parent="1">
          <mxGeometry width="100" height="100" relative="1" as="geometry">
            <mxPoint x="9130" y="470" as="sourcePoint" />
            <mxPoint x="10150" y="475" as="targetPoint" />
          </mxGeometry>
        </mxCell>
      </root>
    </mxGraphModel>
  </diagram>
</mxfile>
